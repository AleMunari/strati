<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audio Test</title>
<style>
  body { background:#111; color:#eee; font-family:monospace; padding:2rem; }
  button { display:block; width:100%; padding:1.2rem; margin:0.8rem 0; 
           background:#222; border:1px solid #555; color:#eee; font-size:1rem; cursor:pointer; }
  button:active { background:#333; }
  .ok { border-color:#5a8 !important; color:#5a8 !important; }
  .err { border-color:#c55 !important; color:#c55 !important; }
  #log { margin-top:1rem; font-size:0.75rem; line-height:2; color:#aaa; }
</style>
</head>
<body>
<h2>ðŸ”Š Audio Test â€” iOS Safari</h2>
<p style="font-size:0.8rem;color:#888">Testa ogni pulsante in ordine. Leggi i log sotto.</p>

<button id="b1" onclick="test1()">TEST 1 â€” speechSynthesis diretto</button>
<button id="b2" onclick="test2()">TEST 2 â€” speechSynthesis con dummy prima</button>
<button id="b3" onclick="test3()">TEST 3 â€” Audio element blob (simula EL)</button>
<button id="b4" onclick="test4()">TEST 4 â€” Silent loop + speechSynthesis</button>
<button id="b5" onclick="test5()">TEST 5 â€” Silent loop STOP + speechSynthesis</button>
<button id="b6" onclick="test6()">TEST 6 â€” ElevenLabs reale (serve chiave)</button>
<input id="el-key-test" placeholder="Incolla chiave ElevenLabs per test 6" 
  style="width:100%;padding:0.8rem;background:#1a1a1a;border:1px solid #333;color:#eee;font-size:0.85rem;margin:0.4rem 0">

<div id="log"></div>

<audio id="test-audio" preload="none" style="display:none"></audio>

<script>
const SILENT = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
const a = document.getElementById('test-audio');
let silentRunning = false;

function log(msg, color) {
  const d = document.getElementById('log');
  const t = new Date().toTimeString().slice(0,8);
  d.innerHTML = '<div style="color:' + (color||'#aaa') + '">' + t + ' ' + msg + '</div>' + d.innerHTML;
}

// TEST 1: speechSynthesis semplice
function test1() {
  log('TEST 1: speechSynthesis.speak() diretto...');
  const s = window.speechSynthesis;
  if (!s) { log('âœ— No speechSynthesis', '#c55'); return; }
  s.cancel();
  const u = new SpeechSynthesisUtterance('Prova uno. Sento la voce italiana?');
  u.lang = 'it-IT'; u.rate = 0.9; u.volume = 1;
  const voices = s.getVoices();
  const itV = voices.find(v => v.lang.startsWith('it'));
  if (itV) { u.voice = itV; log('voce: ' + itV.name); }
  else log('nessuna voce IT â€” voci totali: ' + voices.length, '#fa0');
  u.onstart = () => log('â–¶ onstart fired', '#5a8');
  u.onend = () => log('â–  onend fired', '#5a8');
  u.onerror = e => log('âœ— onerror: ' + e.error, '#c55');
  s.speak(u);
  log('speak() chiamato â€” speaking=' + s.speaking + ' pending=' + s.pending);
  document.getElementById('b1').classList.add('ok');
}

// TEST 2: dummy prima
function test2() {
  log('TEST 2: dummy silenziosa + testo reale...');
  const s = window.speechSynthesis;
  s.cancel();
  const voices = s.getVoices();
  const itV = voices.find(v => v.lang.startsWith('it'));
  const dummy = new SpeechSynthesisUtterance(' ');
  dummy.volume = 0; if (itV) dummy.voice = itV;
  s.speak(dummy);
  setTimeout(() => {
    const u = new SpeechSynthesisUtterance('Prova due. Funziona con la dummy prima?');
    u.lang = 'it-IT'; u.rate = 0.9; u.volume = 1;
    if (itV) u.voice = itV;
    u.onstart = () => log('â–¶ TEST2 onstart', '#5a8');
    u.onend = () => log('â–  TEST2 onend', '#5a8');
    u.onerror = e => log('âœ— TEST2 onerror: ' + e.error, '#c55');
    s.speak(u);
    log('TEST2 speak() â€” speaking=' + s.speaking);
  }, 100);
  document.getElementById('b2').classList.add('ok');
}

// TEST 3: audio element con blob MP3 (SIMULA ElevenLabs)
function test3() {
  log('TEST 3: Audio element con URL mp3 reale...');
  // Usa un mp3 pubblico per testare se audio element funziona
  const url = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
  a.src = url; a.loop = false; a.volume = 1;
  a.onplay = () => log('â–¶ audio.onplay fired', '#5a8');
  a.onended = () => log('â–  audio.onended fired', '#5a8');
  a.onerror = e => log('âœ— audio.onerror: ' + (e.message||JSON.stringify(e)), '#c55');
  a.load();
  a.play()
    .then(() => log('âœ“ play() promise resolved', '#5a8'))
    .catch(e => log('âœ— play() rejected: ' + e.name + ' â€” ' + e.message, '#c55'));
  document.getElementById('b3').classList.add('ok');
}

// TEST 4: avvia silent loop POI speechSynthesis (il problema che abbiamo)
function test4() {
  log('TEST 4: silent loop attivo + speechSynthesis (riproduce entrambi?)...');
  a.src = SILENT; a.loop = true; a.volume = 0;
  a.play().then(() => {
    log('silent loop avviato', '#5a8');
    silentRunning = true;
    setTimeout(() => {
      log('ora chiamo speechSynthesis CON silent loop attivo...');
      const s = window.speechSynthesis;
      s.cancel();
      const voices = s.getVoices();
      const itV = voices.find(v => v.lang.startsWith('it'));
      const u = new SpeechSynthesisUtterance('Prova quattro. Sento qualcosa con il loop silenzioso attivo?');
      u.lang = 'it-IT'; u.volume = 1; u.rate = 0.9;
      if (itV) u.voice = itV;
      u.onstart = () => log('â–¶ TEST4 onstart', '#5a8');
      u.onend = () => log('â–  TEST4 onend', '#5a8');
      u.onerror = e => log('âœ— TEST4 onerror: ' + e.error, '#c55');
      s.speak(u);
      log('TEST4 speak() â€” speaking=' + s.speaking);
    }, 500);
  }).catch(e => log('âœ— silent play failed: ' + e.message, '#c55'));
  document.getElementById('b4').classList.add('ok');
}

// TEST 5: STOP silent loop, POI speechSynthesis
function test5() {
  log('TEST 5: STOP silent loop + speechSynthesis...');
  try { a.pause(); a.src = ''; } catch(e) {}
  silentRunning = false;
  log('silent loop stoppato');
  setTimeout(() => {
    const s = window.speechSynthesis;
    s.cancel();
    const voices = s.getVoices();
    const itV = voices.find(v => v.lang.startsWith('it'));
    const u = new SpeechSynthesisUtterance('Prova cinque. Sento qualcosa dopo aver stoppato il loop?');
    u.lang = 'it-IT'; u.volume = 1; u.rate = 0.9;
    if (itV) u.voice = itV;
    u.onstart = () => log('â–¶ TEST5 onstart', '#5a8');
    u.onend = () => log('â–  TEST5 onend', '#5a8');
    u.onerror = e => log('âœ— TEST5 onerror: ' + e.error, '#c55');
    s.speak(u);
    log('TEST5 speak() â€” speaking=' + s.speaking);
  }, 300);
  document.getElementById('b5').classList.add('ok');
}

// TEST 6: ElevenLabs reale
async function test6() {
  const key = document.getElementById('el-key-test').value.trim();
  if (!key) { log('âœ— Inserisci la chiave ElevenLabs', '#c55'); return; }
  log('TEST 6: ElevenLabs fetch reale...');
  const btn6 = document.getElementById('b6');
  btn6.textContent = 'Caricamento...';
  try {
    const r = await fetch('https://api.elevenlabs.io/v1/text-to-speech/IKne3meq5aSn9XLyUdCD/stream', {
      method: 'POST',
      headers: { 'xi-api-key': key, 'Content-Type': 'application/json', 'Accept': 'audio/mpeg' },
      body: JSON.stringify({ text: 'Prova sei. ElevenLabs funziona correttamente.', model_id: 'eleven_multilingual_v2', voice_settings: { stability: 0.5, similarity_boost: 0.75 } })
    });
    log('EL HTTP: ' + r.status);
    if (!r.ok) { const j = await r.json().catch(()=>({})); log('âœ— EL errore: ' + JSON.stringify(j?.detail), '#c55'); return; }
    const blob = await r.blob();
    log('blob: ' + Math.round(blob.size/1024) + 'KB', '#5a8');
    const url = URL.createObjectURL(blob);
    a.src = url; a.loop = false; a.volume = 1;
    a.onplay = () => { log('â–¶ EL onplay', '#5a8'); btn6.classList.add('ok'); };
    a.onended = () => log('â–  EL fine', '#5a8');
    a.onerror = e => log('âœ— EL audio error: ' + e.type, '#c55');
    a.load();
    await a.play();
    log('âœ“ EL play() ok', '#5a8');
  } catch(e) {
    log('âœ— EL exception: ' + e.message, '#c55');
  }
  btn6.textContent = 'TEST 6 â€” ElevenLabs reale (serve chiave)';
}

// Info iniziali
window.addEventListener('load', () => {
  const s = window.speechSynthesis;
  log('speechSynthesis: ' + (s ? 'disponibile' : 'NON disponibile'));
  const voices = s ? s.getVoices() : [];
  log('voci al load: ' + voices.length);
  if (s) {
    s.onvoiceschanged = () => {
      const vv = s.getVoices();
      log('onvoiceschanged: ' + vv.length + ' voci');
      const it = vv.filter(v => v.lang.startsWith('it'));
      it.forEach(v => log('  IT: ' + v.name + ' (' + v.lang + ') local=' + v.localService));
    };
  }
});
</script>
</body>
</html>