<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>STRATI</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Mono:wght@300;400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  :root {
    --bg: #0c0b09;
    --paper: #13120e;
    --gold: #c9a84c;
    --gold-dim: #9a7d3a;
    --text: #e0dbd0;
    --muted: #8a8278;
    --red: #c03030;
    --fs-base: 1rem;        /* 16px */
    --fs-sm: 0.875rem;      /* 14px */
    --fs-xs: 0.75rem;       /* 12px */
    --fs-lg: 1.125rem;      /* 18px */
    --fs-xl: 1.375rem;      /* 22px */
    --lh: 1.65;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 16px;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  body::before {
    content:'';
    position:fixed; inset:0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
    pointer-events:none; z-index:1000; opacity:0.5;
  }

  body::after {
    content:'';
    position:fixed; inset:0;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.35) 100%);
    pointer-events:none; z-index:999;
  }

  /* ‚ïê‚ïê SPLASH ‚ïê‚ïê */
  #splash {
    position:fixed; inset:0; background:#000;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    z-index:2000; transition:opacity 2s ease; padding:2rem 2rem 4rem;
    overflow-y: auto;
  }
  #splash.hidden { opacity:0; pointer-events:none; }

  .s-eyebrow {
    font-size:0.85rem; letter-spacing:0.4em;
    color:var(--gold-dim); text-transform:uppercase; margin-bottom:1rem;
  }
  .s-title {
    font-family:'Playfair Display',serif;
    font-size:clamp(4rem,18vw,9rem); font-weight:400;
    letter-spacing:0.15em; color:#fff; line-height:1;
    text-shadow:0 0 80px rgba(201,168,76,0.3);
    animation:title-breathe 4s ease-in-out infinite;
  }
  @keyframes title-breathe {
    0%,100%{text-shadow:0 0 80px rgba(201,168,76,0.3);}
    50%{text-shadow:0 0 120px rgba(201,168,76,0.5),0 0 200px rgba(201,168,76,0.15);}
  }
  .s-sub {
    font-size:0.9rem; letter-spacing:0.2em;
    color:var(--muted); margin-top:0.8rem; text-transform:uppercase;
  }
  .s-divider { width:60px; height:1px; background:var(--gold-dim); margin:2rem auto; }
  .s-desc {
    font-size:1rem; color:var(--muted); line-height:1.9;
    text-align:center; max-width:320px; letter-spacing:0.03em;
  }
  .s-desc em { color:var(--text); font-style:normal; }

  .key-block { margin-top:1.8rem; width:100%; max-width:340px; }
  .key-block + .key-block { margin-top:1.4rem; }

  .key-lbl {
    font-size:0.82rem; letter-spacing:0.18em; color:var(--muted);
    text-transform:uppercase; display:block; margin-bottom:0.6rem;
  }
  .key-row { display:flex; gap:0.5rem; }
  .key-inp {
    flex:1; background:#0a0a08; border:1px solid #2a2820;
    color:var(--text); font-family:'IBM Plex Mono',monospace;
    font-size:16px; /* CRITICO: evita zoom iOS */
    padding:0.75rem 0.9rem; outline:none; transition:border-color 0.3s;
    min-height:48px;
  }
  .key-inp:focus { border-color:var(--gold-dim); }
  .key-btn {
    padding:0.75rem 1.1rem; background:transparent;
    border:1px solid var(--gold-dim); color:var(--text);
    font-family:'IBM Plex Mono',monospace; font-size:0.88rem;
    letter-spacing:0.1em; cursor:pointer; transition:all 0.3s; white-space:nowrap;
    min-height:48px;
  }
  .key-btn:hover { background:var(--gold-dim); }
  .key-st {
    margin-top:0.5rem; font-size:0.82rem; color:var(--muted);
    letter-spacing:0.08em; min-height:1.1rem;
  }
  .key-st.ok { color:#5a8a5a; }
  .key-st.err { color:var(--red); }
  .key-st.req { color:var(--gold-dim); }

  .start-btn {
    margin-top:2.5rem; padding:1.1rem 3.5rem; background:transparent;
    border:1px solid var(--gold-dim); color:var(--gold);
    font-family:'IBM Plex Mono',monospace; font-size:0.9rem;
    letter-spacing:0.35em; text-transform:uppercase; cursor:pointer;
    transition:all 0.4s; position:relative; overflow:hidden;
    min-height:54px; align-self:center; flex-shrink:0;
  }
  .start-btn::before {
    content:''; position:absolute; inset:0; background:var(--gold-dim);
    transform:scaleX(0); transform-origin:left; transition:transform 0.4s; z-index:-1;
  }
  .start-btn:hover::before { transform:scaleX(1); }
  .start-btn:hover { color:#fff; border-color:transparent; }

  .s-warning {
    margin-top:1.5rem; font-size:0.82rem; color:var(--muted);
    letter-spacing:0.08em; text-align:center; line-height:2;
    padding-bottom: 5rem;
  }

  /* ‚ïê‚ïê APP ‚ïê‚ïê */
  #app { display:none; flex-direction:column; min-height:100dvh; }
  #app.visible { display:flex; }

  header {
    display:flex; justify-content:space-between; align-items:center;
    padding:1rem 1.5rem; border-bottom:1px solid #1e1c18;
    position:sticky; top:0;
    background:rgba(12,11,9,0.96); backdrop-filter:blur(12px); z-index:100;
  }
  .app-title {
    font-family:'Playfair Display',serif; font-size:1.5rem;
    letter-spacing:0.2em; color:var(--gold); font-weight:400;
  }
  .hdr-right { display:flex; align-items:center; gap:0.8rem; font-size:var(--fs-sm); letter-spacing:0.12em; color:var(--muted); }

  #mute-btn {
    background: transparent; border: 1px solid #2a2820; color: var(--muted);
    font-size: 1rem; padding: 0.3rem 0.6rem; cursor: pointer;
    transition: all 0.3s; min-height: 36px; min-width: 44px;
    display: flex; align-items: center; justify-content: center;
  }
  #mute-btn:hover { border-color: var(--gold-dim); }
  #mute-btn.muted { color: #4a4440; border-color: #1e1c18; }

  .gps-dot { width:9px; height:9px; border-radius:50%; background:#2a2820; display:inline-block; margin-right:0.4rem; flex-shrink:0; }
  .gps-dot.lock {
    background:var(--gold); box-shadow:0 0 8px rgba(201,168,76,0.7);
    animation:gps-pulse 2s ease-in-out infinite;
  }
  @keyframes gps-pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

  .coord-strip {
    padding:0.6rem 1.5rem; border-bottom:1px solid #131210;
    display:flex; align-items:center;
    font-size:var(--fs-sm); letter-spacing:0.06em; color:var(--muted);
    font-style: italic;
  }

  .stats-row {
    display:flex; justify-content:space-around;
    padding:1.2rem 1rem; border-bottom:1px solid #131210;
  }
  .stat { text-align:center; padding:0 0.5rem; }
  .stat-val {
    font-family:'Playfair Display',serif; font-size:1.75rem;
    color:var(--gold); display:block; line-height:1.1; font-style:italic;
  }
  .stat-lbl { font-size:0.72rem; letter-spacing:0.18em; color:var(--muted); text-transform:uppercase; margin-top:0.2rem; display:block; }

  .epoch-bar {
    padding:0.9rem 1.5rem; border-bottom:1px solid #131210;
    display:flex; align-items:center; gap:1rem;
  }
  .epoch-label { font-size:0.78rem; letter-spacing:0.22em; color:var(--muted); text-transform:uppercase; white-space:nowrap; }
  .epoch-value { font-family:'Playfair Display',serif; font-size:1.2rem; color:var(--gold); font-style:italic; }
  .epoch-bar::after { content:''; flex:1; height:1px; background:#1a1810; }

  .search-status {
    padding:0.7rem 1.5rem; border-bottom:1px solid #0f0e0c;
    font-size:var(--fs-sm); color:var(--muted); letter-spacing:0.08em;
    display:flex; align-items:center; gap:0.6rem; min-height:2.8rem;
  }
  .search-dot { width:6px; height:6px; border-radius:50%; background:var(--gold); opacity:0; flex-shrink:0; }
  .search-dot.on { animation:sdot 0.8s ease-in-out infinite; }
  @keyframes sdot{0%,100%{opacity:0.2;}50%{opacity:1;}}

  .progress-wrap { padding:0.7rem 1.5rem; border-bottom:1px solid #0f0e0c; }
  .progress-top {
    display:flex; justify-content:space-between;
    font-size:0.78rem; letter-spacing:0.12em; color:var(--muted); text-transform:uppercase; margin-bottom:0.5rem;
  }
  .progress-bar { height:2px; background:#1a1810; border-radius:2px; }
  .progress-fill {
    height:100%; background:linear-gradient(90deg,var(--gold-dim),var(--gold));
    width:0%; transition:width 1s ease; border-radius:2px;
  }

  .story-wrap { flex:1; padding:1.5rem; }

  .frag-header { display:flex; align-items:flex-start; gap:1rem; margin-bottom:1.4rem; }
  .frag-num-box {
    font-family:'Playfair Display',serif; font-size:3rem;
    color:var(--gold-dim); font-style:italic; line-height:1; flex-shrink:0;
  }
  .frag-meta-col { flex:1; min-width:0; }
  .frag-place { font-family:'Playfair Display',serif; font-size:1.25rem; color:var(--gold); font-style:italic; margin-bottom:0.3rem; line-height:1.3; }
  .frag-coords-lbl { font-size:0.78rem; letter-spacing:0.1em; color:var(--muted); }

  .gen-wrap { display:none; align-items:center; gap:0.7rem; margin-bottom:1.2rem; font-size:var(--fs-sm); letter-spacing:0.12em; color:var(--muted); }
  .gen-wrap.on { display:flex; }
  .gen-d { width:6px; height:6px; border-radius:50%; background:var(--gold); animation:gdot 1s ease-in-out infinite; flex-shrink:0; }
  .gen-d:nth-child(2){animation-delay:0.25s;} .gen-d:nth-child(3){animation-delay:0.5s;}
  @keyframes gdot{0%,100%{opacity:0.15;}50%{opacity:1;}}

  .story-text { font-size:var(--fs-lg); line-height:var(--lh); color:var(--text); min-height:80px; }
  .story-text.no-data { color: var(--muted); font-size: var(--fs-base); }

  .cursor-blink {
    display:inline-block; width:9px; height:1em;
    background:var(--text); vertical-align:text-bottom;
    animation:blink 1s step-end infinite; margin-left:2px;
  }
  @keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}

  .sources-wrap { margin-top:1.4rem; padding-top:0.9rem; border-top:1px solid #1a1810; display:none; }
  .sources-wrap.on { display:block; }
  .sources-lbl { font-size:0.78rem; letter-spacing:0.25em; color:var(--muted); text-transform:uppercase; margin-bottom:0.7rem; }
  .source-tag {
    display:inline-flex; align-items:center; font-size:var(--fs-sm); letter-spacing:0.05em;
    color:var(--gold-dim); border:1px solid #2a2418;
    padding:0.4rem 0.8rem; margin:0.3rem 0.3rem 0.3rem 0;
    cursor:pointer; transition:color 0.2s; text-decoration:none;
    min-height:40px;
  }
  .source-tag:hover { color:var(--gold); }

  .audio-btn {
    margin-top:2rem; width:100%; padding:1.2rem; background:transparent;
    border:1px solid #1e1c18; color:var(--muted);
    font-family:'IBM Plex Mono',monospace; font-size:var(--fs-base);
    letter-spacing:0.15em; text-transform:uppercase; cursor:pointer; transition:all 0.3s;
    display:flex; align-items:center; justify-content:center; gap:0.7rem;
    min-height:56px;
  }
  .audio-btn:hover { border-color:var(--gold-dim); color:var(--text); }
  .audio-btn.speaking { border-color:var(--gold); color:var(--gold); animation:ab-pulse 2s ease-in-out infinite; }
  .audio-btn.loading { color:#2a2820; border-color:#1e1c18; }
  @keyframes ab-pulse{0%,100%{box-shadow:0 0 0 0 rgba(201,168,76,0);}50%{box-shadow:0 0 0 8px rgba(201,168,76,0.06);}}

  .history-wrap { padding:0 1.5rem 3rem; border-top:1px solid #0f0e0c; }
  .hist-lbl { font-size:0.78rem; letter-spacing:0.3em; color:var(--muted); text-transform:uppercase; padding:1.2rem 0 1rem; }
  .hist-item {
    padding:1rem 0 1rem 1.2rem; border-left:2px solid #2a2820;
    margin-bottom:1rem; cursor:pointer; transition:border-color 0.3s;
    min-height:44px;
  }
  .hist-item:hover { border-left-color:var(--gold-dim); }
  .hist-place { font-family:'Playfair Display',serif; font-size:1rem; color:var(--gold-dim); font-style:italic; margin-bottom:0.3rem; }
  .hist-epoch { font-size:0.72rem; letter-spacing:0.15em; color:var(--muted); margin-bottom:0.4rem; }
  .hist-preview { font-size:var(--fs-sm); color:#7a7468; line-height:1.6; }

  #flash { position:fixed; inset:0; background:rgba(201,168,76,0.03); pointer-events:none; z-index:998; opacity:0; transition:opacity 0.08s; }
  #flash.on { opacity:1; }

  

  .nline { position:fixed; left:0; right:0; height:1px; background:rgba(201,168,76,0.15); pointer-events:none; z-index:997; opacity:0; animation:nline 14s linear infinite; }
  @keyframes nline{0%{top:-1px;opacity:0;}2%{opacity:0.15;}98%{opacity:0.04;}100%{top:100vh;opacity:0;}}

  .frag-address { font-size:0.78rem; letter-spacing:0.06em; color:var(--gold-dim); margin-bottom:0.25rem; min-height:1rem; }

  .place-photo-wrap { margin-bottom:1.2rem; display:none; }
  .place-photo-wrap.on { display:block; }
  .place-photo-container {
    width: 100%; aspect-ratio: 16/9; overflow: hidden;
    border: 1px solid #2a2418; border-bottom: none;
  }
  .place-photo {
    width: 100%; height: 100%;
    object-fit: cover; object-position: center center;
    filter: brightness(0.88) saturate(0.75);
    display: block;
  }
  .place-photo-caption {
    font-size:0.68rem; letter-spacing:0.08em; color:var(--muted);
    padding:0.35rem 0.5rem; border:1px solid #2a2418; border-top: 1px solid #1a1612;
    background:#0e0d0b; line-height:1.5;
  }

  /* ‚ïê‚ïê APPROFONDISCI ‚ïê‚ïê */
  .approfondisci-btn {
    margin-top: 1.4rem; width: 100%; padding: 1rem;
    background: transparent; border: 1px solid #2a2418;
    color: var(--gold-dim); font-family: 'IBM Plex Mono', monospace;
    font-size: 0.82rem; letter-spacing: 0.25em; text-transform: uppercase;
    cursor: pointer; transition: all 0.35s;
    display: flex; align-items: center; justify-content: center; gap: 0.6rem;
    min-height: 52px;
  }
  .approfondisci-btn:hover { border-color: var(--gold-dim); color: var(--gold); }
  .approfondisci-btn.loading { color: #3a3020; border-color: #1e1c18; pointer-events: none; }
  .approfondisci-btn.done { display: none; }

  .approfondimento-wrap {
    display: none; margin-top: 0;
    border-top: 1px solid #1e1c18;
  }
  .approfondimento-wrap.on { display: block; }

  .approfondimento-section {
    padding: 1.2rem 0; border-bottom: 1px solid #131210;
  }
  .approfondimento-section:last-child { border-bottom: none; }
  .approfondimento-lbl {
    font-size: 0.68rem; letter-spacing: 0.3em; color: var(--gold-dim);
    text-transform: uppercase; margin-bottom: 0.8rem; display: flex;
    align-items: center; gap: 0.5rem;
  }
  .approfondimento-lbl::before {
    content: ''; display: inline-block; width: 16px; height: 1px;
    background: var(--gold-dim);
  }
  .approfondimento-text {
    font-size: var(--fs-base); line-height: var(--lh); color: var(--text);
  }


  /* ‚ïê‚ïê AUDIO QUEUE BAR ‚ïê‚ïê */
  #audio-queue-bar {
    display: none; position: sticky; bottom: 0; left: 0; right: 0;
    background: rgba(12,11,9,0.97); backdrop-filter: blur(12px);
    border-top: 1px solid #2a2418; padding: 0.7rem 1.5rem;
    z-index: 500; align-items: center; gap: 0.8rem;
  }
  #audio-queue-bar.on { display: flex; }
  .aqb-label {
    flex: 1; font-size: 0.75rem; letter-spacing: 0.1em; color: var(--gold-dim);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .aqb-btn {
    background: transparent; border: 1px solid #2a2820; color: var(--muted);
    font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem;
    letter-spacing: 0.12em; padding: 0.4rem 0.8rem; cursor: pointer;
    transition: all 0.25s; min-height: 36px; white-space: nowrap;
  }
  .aqb-btn:hover { border-color: var(--gold-dim); color: var(--text); }
  .aqb-btn.stop { border-color: #3a2020; color: #c06060; }
  .aqb-btn.stop:hover { border-color: var(--red); color: var(--red); }
  .aqb-dot {
    width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
    background: var(--gold); animation: gps-pulse 1.2s ease-in-out infinite;
  }

  /* ‚ïê‚ïê MAPPA ‚ïê‚ïê */
  .map-section {
    border-top: 1px solid #131210;
    padding: 0.7rem 1.5rem;
  }
  .map-toggle-btn {
    width: 100%; padding: 0.9rem; background: transparent;
    border: 1px solid #1e1c18; color: var(--muted);
    font-family: 'IBM Plex Mono', monospace; font-size: var(--fs-sm);
    letter-spacing: 0.18em; text-transform: uppercase; cursor: pointer;
    transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.6rem;
    min-height: 52px;
  }
  .map-toggle-btn:hover { border-color: var(--gold-dim); color: var(--text); }
  .map-toggle-btn.active { border-color: var(--gold-dim); color: var(--gold); }
  #map-container {
    display: none; height: 220px; margin-top: 0.7rem;
    border: 1px solid #1e1c18; position: relative; overflow: hidden;
  }
  #map-container.visible { display: block; }
  #map { width: 100%; height: 100%; }
  .leaflet-container { background: #0c0b09 !important; }
  .leaflet-tile { filter: invert(1) hue-rotate(180deg) saturate(0.4) brightness(0.6); }

  /* ‚ïê‚ïê CACHE BADGE ‚ïê‚ïê */
  .cache-badge {
    font-size: 0.62rem; letter-spacing: 0.2em; color: #5a8a5a;
    padding: 0.15rem 0.4rem; border: 1px solid #2a4a2a;
    display: inline-block; margin-left: 0.5rem; vertical-align: middle;
    text-transform: uppercase;
  }

  /* ‚ïê‚ïê END SESSION ‚ïê‚ïê */
  #end-overlay {
    display: none; position: fixed; inset: 0; background: var(--bg);
    z-index: 5000; overflow-y: auto; padding: 2rem 1.5rem 4rem;
  }
  #end-overlay.visible { display: block; }
  .end-header {
    text-align: center; padding: 2rem 0 1.5rem;
    border-bottom: 1px solid #1e1c18; margin-bottom: 2rem;
  }
  .end-eyebrow { font-size: 0.72rem; letter-spacing: 0.5em; color: var(--muted); text-transform: uppercase; margin-bottom: 0.8rem; }
  .end-title {
    font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 12vw, 5rem);
    color: var(--gold); font-weight: 400; font-style: italic; letter-spacing: 0.1em;
    text-shadow: 0 0 60px rgba(201,168,76,0.3);
  }
  .end-sub { font-size: 0.8rem; letter-spacing: 0.2em; color: var(--muted); margin-top: 0.6rem; text-transform: uppercase; }
  .end-stats {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
    background: #1a1810; border: 1px solid #1a1810; margin-bottom: 2rem;
  }
  .end-stat {
    background: var(--paper); padding: 1.2rem; text-align: center;
  }
  .end-stat-val {
    font-family: 'Playfair Display', serif; font-size: 1.8rem;
    color: var(--gold); display: block; font-style: italic; line-height: 1;
  }
  .end-stat-lbl { font-size: 0.68rem; letter-spacing: 0.25em; color: var(--muted); text-transform: uppercase; margin-top: 0.3rem; display: block; }
  .end-epochs {
    margin-bottom: 2rem; padding: 1rem; border: 1px solid #1e1c18;
  }
  .end-epochs-lbl { font-size: 0.7rem; letter-spacing: 0.3em; color: var(--muted); text-transform: uppercase; margin-bottom: 0.8rem; }
  .epoch-pill {
    display: inline-block; font-size: 0.72rem; letter-spacing: 0.1em;
    color: var(--gold-dim); border: 1px solid #2a2418;
    padding: 0.3rem 0.6rem; margin: 0.2rem;
  }
  .end-log { margin-bottom: 2rem; }
  .end-log-lbl { font-size: 0.7rem; letter-spacing: 0.35em; color: var(--muted); text-transform: uppercase; margin-bottom: 1rem; }
  .end-log-item {
    padding: 0.8rem 0 0.8rem 1rem; border-left: 1px solid #1e1c18;
    margin-bottom: 0.6rem;
  }
  .end-log-place { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold); font-style: italic; }
  .end-log-epoch { font-size: 0.7rem; letter-spacing: 0.2em; color: var(--muted); margin: 0.2rem 0; }
  .end-log-text { font-size: 0.82rem; color: var(--muted); line-height: 1.7; margin-top: 0.4rem; }
  .end-actions { display: flex; flex-direction: column; gap: 0.8rem; }
  .end-btn {
    width: 100%; padding: 0.9rem; background: transparent;
    font-family: 'IBM Plex Mono', monospace; font-size: 0.82rem;
    letter-spacing: 0.25em; text-transform: uppercase; cursor: pointer; transition: all 0.3s;
  }
  .end-btn-primary { border: 1px solid var(--gold-dim); color: var(--gold); }
  .end-btn-primary:hover { background: var(--gold-dim); color: #fff; }
  .end-btn-secondary { border: 1px solid #1e1c18; color: var(--muted); }
  .end-btn-secondary:hover { border-color: #2a2820; color: var(--text); }
  .end-map { height: 180px; border: 1px solid #1e1c18; margin-bottom: 2rem; }
  #end-map { width: 100%; height: 100%; }
</style>
</head>
<body>

<div class="nline"></div>

<!-- SPLASH -->
<div id="splash">
  <!-- PULSANTE IN CIMA -->
  <div style="width:100%;max-width:340px;display:flex;flex-direction:column;align-items:center;gap:0.5rem;margin-bottom:1.5rem;">
    <button type="button" class="start-btn" id="start-btn" style="margin-top:0;width:100%;letter-spacing:0.2em;" onclick="unifiedStart()">
      <span id="start-btn-label">üîë Usa Passkey</span>
    </button>
    <div class="key-st" id="unified-st" style="text-align:center;min-height:1.1rem;"></div>
    <div id="manual-start-link" style="display:none;gap:0;">
      <span style="font-size:0.75rem;color:var(--muted);letter-spacing:0.12em;cursor:pointer;text-decoration:underline;text-decoration-color:#3a3830;" onclick="startAppDirect()">Entra senza salvare</span>
      <span style="font-size:0.75rem;color:#3a3830;letter-spacing:0.12em;"> ¬∑ </span>
      <span style="font-size:0.75rem;color:var(--muted);letter-spacing:0.12em;cursor:pointer;" onclick="bioClearInline()">‚úï dimentica</span>
    </div>
  </div>

  <div class="s-eyebrow">Una camminata nella memoria</div>
  <div class="s-title">STRATI</div>
  <div class="s-sub">Storia viva sotto i tuoi piedi</div>
  <div class="s-divider"></div>
  <div class="s-desc">
    Cammini. Il GPS ti localizza.<br>
    L'AI cerca cosa √® successo <em>esattamente l√¨</em>.<br>
    Dall'antichit√† alla cronaca di ieri.
  </div>

  <!-- GROQ KEY ‚Äî OBBLIGATORIA -->
  <div class="key-block">
    <span class="key-lbl">‚ú¶ Groq API Key ‚Äî necessaria per la narrazione</span>
    <div class="key-row">
      <input class="key-inp" id="gem-key" type="password" placeholder="Incolla la tua Groq key..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <button type="button" class="key-btn" onclick="testOpenAI()">Verifica</button>
    </div>
    <div class="key-st req" id="gem-st">‚Üí Ottienila gratis su console.groq.com</div>
  </div>

  <!-- ELEVENLABS KEY ‚Äî voce narrante -->
  <div class="key-block">
    <span class="key-lbl">üéô ElevenLabs API Key ‚Äî voce narrante</span>
    <div class="key-row">
      <input class="key-inp" id="el-key" type="password" placeholder="Incolla la tua ElevenLabs key..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <button type="button" class="key-btn" onclick="testEL()">Verifica</button>
    </div>
    <div class="key-st req" id="el-st">‚Üí Ottienila su elevenlabs.io</div>
  </div>

  <div class="s-warning">
    Usa le cuffie ¬∑ Cammina in luoghi sicuri<br>
    Dati storici da Wikipedia e OpenStreetMap
  </div>
  <div id="gps-denied-msg" style="display:none;margin-top:1.2rem;width:100%;max-width:340px;background:#1a0e0e;border:1px solid #5a2020;padding:1rem 1.2rem;">
    <div style="font-size:0.78rem;color:#c07070;letter-spacing:0.08em;line-height:1.9;">
      ‚ö† GPS bloccato su questo browser.<br>
      <strong style="color:#e08080;">Impostazioni ‚Üí Privacy e sicurezza<br>‚Üí Localizzazione ‚Üí Safari ‚Üí Consenti</strong><br>
      <span style="color:var(--muted);font-size:0.72rem;">Poi ricarica la pagina.</span>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="app-title">STRATI</div>
    <div class="hdr-right">
      <span><span class="gps-dot" id="gps-dot"></span><span id="gps-txt">attesa</span></span>
      <button type="button" id="mute-btn" onclick="toggleMute()" title="Silenzia narrazione">üîä</button>
    </div>
  </header>

  <div class="coord-strip">
    <span id="addr-strip">‚Äî</span>
  </div>

  <div class="stats-row">
    <div class="stat"><span class="stat-val" id="s-dist">‚Äî</span><span class="stat-lbl">metri</span></div>
    <div class="stat"><span class="stat-val" id="s-frags">0</span><span class="stat-lbl">luoghi</span></div>
    <div class="stat"><span class="stat-val" id="s-layers">‚Äî</span><span class="stat-lbl">epoche</span></div>
    <div class="stat"><span class="stat-val" id="s-time">‚Äî</span><span class="stat-lbl">ora</span></div>
  </div>

  <div class="epoch-bar">
    <span class="epoch-label">Epoca</span>
    <span class="epoch-value" id="epoch-val">in ricerca...</span>
  </div>

  <div id="el-warning" style="display:none;background:#1a1208;border-bottom:1px solid #5a4010;padding:0.6rem 1.5rem;font-size:0.78rem;color:#c09050;letter-spacing:0.06em;line-height:1.7;">
    ‚ö† ElevenLabs non disponibile ‚Äî narrazione con voce di sistema.
    <span style="color:var(--muted);font-size:0.72rem;display:block;">Causa: account free bloccato o quota esaurita. Ricarica la pagina per reinserire la chiave.</span>
  </div>

  <div class="search-status" id="search-status">
    <div class="search-dot" id="search-dot"></div>
    <span id="search-txt">GPS in calibrazione ‚Äî comincia a camminare</span>
  </div>

  <div class="progress-wrap">
    <div class="progress-top">
      <span>Prossimo luogo</span>
      <span id="prog-next">‚Äî</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>
  </div>

  <div class="story-wrap">
    <div class="frag-header">
      <div class="frag-num-box" id="frag-n">‚Äî</div>
      <div class="frag-meta-col">
        <div class="frag-place" id="frag-place">In attesa di segnale...</div>
        <div class="frag-address" id="frag-address"></div>
        <div class="frag-coords-lbl" id="frag-coords"></div>
      </div>
    </div>

    <div class="gen-wrap" id="gen-wrap">
      <div class="gen-d"></div><div class="gen-d"></div><div class="gen-d"></div>
      <span>ricerca e narrazione in corso</span>
    </div>

    <div class="place-photo-wrap" id="place-photo-wrap"></div>

    <div class="story-text" id="story-text">
      <span style="color:var(--muted)">Quando il GPS sar√† pronto, la storia del luogo emerger√† dalla terra.</span>
    </div>

    <div class="sources-wrap" id="sources-wrap">
      <div class="sources-lbl">Fonti</div>
      <div id="sources-list"></div>
    </div>

    <button type="button" class="audio-btn" id="audio-btn" onclick="speakCurrent()">
      <span id="audio-icon">‚ñ∂</span>
      <span id="audio-lbl">Ascolta narrazione</span>
    </button>

    <button type="button" class="approfondisci-btn" id="approfondisci-btn" onclick="approfondisci()" style="display:none;">
      <span id="approfondisci-icon">‚ú¶</span>
      <span id="approfondisci-lbl">Approfondisci</span>
    </button>

    <div class="approfondimento-wrap" id="approfondimento-wrap">
      <div class="approfondimento-section" id="app-cronologia" style="display:none;">
        <div class="approfondimento-lbl">Cronologia</div>
        <div class="approfondimento-text" id="app-cronologia-text"></div>
      </div>
      <div class="approfondimento-section" id="app-personaggi" style="display:none;">
        <div class="approfondimento-lbl">Personaggi</div>
        <div class="approfondimento-text" id="app-personaggi-text"></div>
      </div>
      <div class="approfondimento-section" id="app-connessioni" style="display:none;">
        <div class="approfondimento-lbl">Luoghi connessi</div>
        <div class="approfondimento-text" id="app-connessioni-text"></div>
      </div>
      <div class="approfondimento-section" id="app-aneddoti" style="display:none;">
        <div class="approfondimento-lbl">Aneddoti</div>
        <div class="approfondimento-text" id="app-aneddoti-text"></div>
      </div>
    </div>
  </div>

  <div class="history-wrap">
    <div class="hist-lbl">Luoghi visitati</div>
    <div id="hist-list"></div>
  </div>

  <!-- MAPPA -->
  <div class="map-section">
    <button type="button" class="map-toggle-btn" id="map-toggle-btn" onclick="toggleMap()">
      <span id="map-icon">‚óé</span><span id="map-btn-txt"> Mostra percorso su mappa</span>
    </button>
    <div id="map-container">
      <div id="map"></div>
    </div>
  </div>

  <!-- FINE SESSIONE -->
  <div style="padding:1rem 1.5rem 2rem;">
    <button type="button" class="end-btn end-btn-secondary" style="width:100%;border:1px solid #1e1c18;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:0.78rem;letter-spacing:0.2em;text-transform:uppercase;cursor:pointer;padding:0.8rem;background:transparent;transition:all 0.3s;" onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'" onmouseout="this.style.borderColor='#1e1c18';this.style.color='var(--muted)'" onclick="endSession()">
      ‚ú¶ Fine camminata ‚Äî Vedi riepilogo
    </button>
  </div>
</div>

<!-- FINE SESSIONE -->
<div id="end-overlay">
  <div class="end-header">
    <div class="end-eyebrow">Camminata completata</div>
    <div class="end-title">Fine</div>
    <div class="end-sub" id="end-date">‚Äî</div>
  </div>

  <div class="end-stats">
    <div class="end-stat">
      <span class="end-stat-val" id="end-dist">‚Äî</span>
      <span class="end-stat-lbl">metri percorsi</span>
    </div>
    <div class="end-stat">
      <span class="end-stat-val" id="end-places">‚Äî</span>
      <span class="end-stat-lbl">luoghi narrati</span>
    </div>
    <div class="end-stat">
      <span class="end-stat-val" id="end-epochs-n">‚Äî</span>
      <span class="end-stat-lbl">epoche toccate</span>
    </div>
    <div class="end-stat">
      <span class="end-stat-val" id="end-duration">‚Äî</span>
      <span class="end-stat-lbl">minuti di storia</span>
    </div>
  </div>

  <div class="end-epochs" id="end-epochs-wrap">
    <div class="end-epochs-lbl">Epoche attraversate</div>
    <div id="end-epochs-list"></div>
  </div>

  <div class="end-map" id="end-map-wrap">
    <div id="end-map"></div>
  </div>

  <div class="end-log">
    <div class="end-log-lbl">Il tuo diario di viaggio</div>
    <div id="end-log-list"></div>
  </div>

  <div class="end-actions">
    <button type="button" class="end-btn end-btn-primary" onclick="exportDiary()">‚¨á Scarica diario HTML</button>
    <button type="button" class="end-btn end-btn-secondary" onclick="closeEndSession()">‚Üê Torna alla camminata</button>
    <button type="button" class="end-btn end-btn-secondary" onclick="location.reload()">‚ú¶ Nuova camminata</button>
  </div>
</div>

<!-- AUDIO QUEUE BAR -->
<div id="audio-queue-bar">
  <div class="aqb-dot"></div>
  <div class="aqb-label" id="aqb-label">In riproduzione...</div>
  <button type="button" class="aqb-btn" onclick="audioSkip()">‚è≠ Salta</button>
  <button type="button" class="aqb-btn stop" onclick="audioStop()">‚ñ† Ferma</button>
</div>

<div id="flash"></div>
<audio id="strati-audio" preload="none" style="display:none"></audio>

<!-- DEBUG AUDIO PANEL -->
<div id="debug-panel" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#0a0a08;border-top:2px solid #c9a84c;padding:0.6rem 1rem;z-index:9999;font-family:monospace;font-size:0.68rem;color:#c9a84c;max-height:160px;overflow-y:auto;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
    <b>üîä AUDIO DEBUG</b>
    <span style="cursor:pointer;color:#888;padding:0 0.3rem;" onclick="this.closest('#debug-panel').style.display='none'">‚úï</span>
  </div>
  <div id="debug-log" style="line-height:1.8;"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  openaiKey: null,
  elKey: null,
  elVoiceId: 'IKne3meq5aSn9XLyUdCD',
  gpsReady: false,
  lastPos: null,
  currentPos: null,
  anchorPos: null,
  totalDist: 0,
  lastFragAt: -9999,
  lastFragTime: 0,
  lastFragPos: null,
  fragCount: 0,
  currentText: '',
  isSpeaking: false,
  isGenerating: false,
  currentAudio: null,
  speedSamples: [],
  history: [],
  watchId: null,
  synth: window.speechSynthesis,
  epochsVisited: new Set(),
  currentSources: [],
  // NUOVI
  startTime: null,
  muted: false,
  lastAddrPos: null,
  currentApprofondimento: null,
  mapVisible: false,
  leafletMap: null,
  leafletEndMap: null,
  pathLine: null,
  pathCoords: [],
  markerLayer: null,
};

const INTERVAL = 80;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GROQ API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function testOpenAI() {
  const key = document.getElementById('gem-key').value.trim();
  const st = document.getElementById('gem-st');
  if (!key) { st.textContent='Inserisci una chiave'; st.className='key-st err'; return; }
  st.textContent='Verifica...'; st.className='key-st';
  try {
    const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        max_tokens: 10,
        messages:[{ role:'user', content:'Rispondi solo: OK' }]
      })
    });
    if (r.ok) {
      S.openaiKey = key;
      st.textContent='‚úì Groq attivo ‚Äî pronto per la narrazione';
      st.className='key-st ok';
    } else {
      const e = await r.json();
      st.textContent='‚úó ' + (e.error?.message || 'Chiave non valida');
      st.className='key-st err';
    }
  } catch(e) { st.textContent='‚úó Errore di rete'; st.className='key-st err'; }
}

async function callOpenAI(systemPrompt, userPrompt) {
  if (!S.openaiKey) throw new Error('Nessuna Groq key');

  const body = {
    model: 'llama-3.3-70b-versatile',
    temperature: 0.8,
    max_tokens: 1024,
    response_format: { type: 'json_object' },
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ]
  };

  const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+S.openaiKey},
    body: JSON.stringify(body)
  });

  if (!r.ok) {
    const e = await r.json();
    throw new Error('Groq: ' + (e.error?.message || r.status));
  }

  const data = await r.json();
  const raw = data.choices?.[0]?.message?.content || '{}';
  try {
    return JSON.parse(raw);
  } catch(e) {
    const match = raw.match(/\{[\s\S]*\}/);
    if (match) return JSON.parse(match[0]);
    return { place:'‚Äî', epoch:'‚Äî', tone:'documentaristico', text: raw };
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ELEVENLABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function testEL() {
  const key = document.getElementById('el-key').value.trim();
  const st = document.getElementById('el-st');
  if (!key) { st.textContent='Inserisci una chiave'; st.className='key-st err'; return; }
  st.textContent='Verifica...'; st.className='key-st';
  try {
    const r = await fetch('https://api.elevenlabs.io/v1/models', { headers:{'xi-api-key':key} });
    if (r.ok) {
      S.elKey = key;
      st.textContent='‚úì ElevenLabs attivo';
      st.className='key-st ok';
      loadItalianVoice(key);
    } else {
      st.textContent='‚úó Chiave non valida (cod. '+r.status+')';
      st.className='key-st err';
    }
  } catch(e) { st.textContent='‚úó Errore di rete'; st.className='key-st err'; }
}

async function loadItalianVoice(key) {
  try {
    const r = await fetch('https://api.elevenlabs.io/v1/voices', { headers:{'xi-api-key':key} });
    if (!r.ok) return;
    const d = await r.json();
    const v = d.voices.find(v =>
      v.labels?.language==='it' ||
      ['luca','giovanni','marco','mario','italian','alberto','dante'].some(n=>v.name.toLowerCase().includes(n))
    );
    if (v) { S.elVoiceId=v.voice_id; document.getElementById('el-st').textContent+=` ¬∑ ${v.name}`; }
  } catch(e) {}
}

// ‚îÄ‚îÄ DEBUG ‚îÄ‚îÄ
function dbg(msg, color) {
  const el = document.getElementById('debug-log');
  if (!el) return;
  const t = new Date().toTimeString().slice(0,8);
  const d = document.createElement('div');
  d.style.color = color || '#c9a84c';
  d.textContent = t + ' ' + msg;
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
  console.log('[STRATI]', msg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO SYSTEM ‚Äî coda sezioni + voce di qualit√†
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Coda audio: array di { text, label }
const AUDIO_Q = { items: [], current: 0, playing: false };

// Cache voce italiana migliore
let _bestVoice = null;

function getBestItalianVoice() {
  if (_bestVoice) return _bestVoice;
  const voices = window.speechSynthesis?.getVoices() || [];
  // Priorit√†: voci premium iOS (Federica, Alice) ‚Üí qualsiasi IT
  const priority = ['federica','alice','luca','paola','italian'];
  for (const name of priority) {
    const v = voices.find(v => v.lang.startsWith('it') && v.name.toLowerCase().includes(name));
    if (v) { _bestVoice = v; return v; }
  }
  // Fallback: qualsiasi voce italiana
  const itAny = voices.find(v => v.lang.startsWith('it'));
  if (itAny) { _bestVoice = itAny; return itAny; }
  return null;
}

// Precarica voci appena disponibili
function preloadVoices() {
  const voices = window.speechSynthesis?.getVoices() || [];
  if (voices.length > 0) {
    _bestVoice = null; // reset cache
    getBestItalianVoice();
    const v = getBestItalianVoice();
    dbg('voci pronte: ' + voices.length + ' ‚Äî IT: ' + (v ? v.name : 'nessuna'));
  }
}
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = preloadVoices;
  preloadVoices();
}

function updateQueueBar(label) {
  const bar = document.getElementById('audio-queue-bar');
  const lbl = document.getElementById('aqb-label');
  if (!bar) return;
  if (label) {
    bar.classList.add('on');
    if (lbl) lbl.textContent = label;
  } else {
    bar.classList.remove('on');
  }
}

function startSilentLoop() {
  const SILENT = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
  const a = document.getElementById('strati-audio');
  S._audioEl = a;
  a.src = SILENT; a.loop = true; a.volume = 0;
  a.play()
    .then(() => { dbg('‚úì silent loop avviato', '#5a8a5a'); S._audioReady = true; })
    .catch(e => dbg('‚úó silent loop fallito: ' + e.message, '#c03030'));
}

// ‚îÄ‚îÄ CODA PRINCIPALE ‚îÄ‚îÄ
// Aggiunge item alla coda e parte se non sta gi√† suonando
function queueSpeak(text, label) {
  if (!text || S.muted) return;
  AUDIO_Q.items.push({ text, label: label || '‚ñ∂ In riproduzione' });
  if (!AUDIO_Q.playing) playNextInQueue();
}

function playNextInQueue() {
  if (AUDIO_Q.current >= AUDIO_Q.items.length) {
    // Fine coda
    AUDIO_Q.items = []; AUDIO_Q.current = 0; AUDIO_Q.playing = false;
    updateQueueBar(null);
    setAudioUI(false);
    return;
  }
  const item = AUDIO_Q.items[AUDIO_Q.current];
  AUDIO_Q.playing = true;
  updateQueueBar(item.label + ' (' + (AUDIO_Q.current+1) + '/' + AUDIO_Q.items.length + ')');
  setAudioUI(true);
  _speakOne(item.text, () => {
    AUDIO_Q.current++;
    // Pausa tra sezioni (800ms)
    if (AUDIO_Q.current < AUDIO_Q.items.length) {
      setTimeout(playNextInQueue, 800);
    } else {
      AUDIO_Q.items = []; AUDIO_Q.current = 0; AUDIO_Q.playing = false;
      updateQueueBar(null);
      setAudioUI(false);
    }
  });
}

// Salta alla prossima sezione
function audioSkip() {
  dbg('skip sezione');
  _stopCurrentUtterance();
  AUDIO_Q.current++;
  if (AUDIO_Q.current < AUDIO_Q.items.length) {
    setTimeout(playNextInQueue, 300);
  } else {
    AUDIO_Q.items = []; AUDIO_Q.current = 0; AUDIO_Q.playing = false;
    updateQueueBar(null); setAudioUI(false);
  }
}

// Ferma tutto
function audioStop() {
  dbg('stop tutto');
  AUDIO_Q.items = []; AUDIO_Q.current = 0; AUDIO_Q.playing = false;
  _stopCurrentUtterance();
  updateQueueBar(null);
  setAudioUI(false);
}

function _stopCurrentUtterance() {
  if (S.synth) S.synth.cancel();
  const a = S._audioEl;
  if (a && !a.loop) {
    try { a.pause(); } catch(e) {}
    if (a._blobUrl) { URL.revokeObjectURL(a._blobUrl); a._blobUrl = null; }
    const SILENT = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
    a.onplay = null; a.onended = null; a.onerror = null;
    a.src = SILENT; a.loop = true; a.volume = 0; a.play().catch(()=>{});
  }
}

// Riproduce UN singolo testo, chiama onDone quando finisce
function _speakOne(text, onDone) {
  if (S.elKey) {
    // Prova ElevenLabs
    const a = S._audioEl;
    if (!a) { _speakOneSystem(text, onDone); return; }
    fetch('https://api.elevenlabs.io/v1/text-to-speech/' + S.elVoiceId + '/stream', {
      method: 'POST',
      headers: { 'xi-api-key': S.elKey, 'Content-Type': 'application/json', 'Accept': 'audio/mpeg' },
      body: JSON.stringify({
        text: text.replace(/

+/g, '
').trim().slice(0, 500),
        model_id: 'eleven_multilingual_v2',
        voice_settings: { stability: 0.5, similarity_boost: 0.78, style: 0.3, use_speaker_boost: true }
      })
    })
    .then(async r => {
      dbg('EL HTTP ' + r.status);
      if (!r.ok) {
        if (r.status === 401 || r.status === 403) {
          try {
            const errBody = await r.json();
            const status = errBody?.detail?.status || '';
            dbg('EL blocked: ' + status, '#f0a030');
          } catch(e) {}
          S.elKey = null;
          const w = document.getElementById('el-warning');
          if (w) w.style.display = 'block';
        }
        throw new Error('HTTP ' + r.status);
      }
      return r.blob();
    })
    .then(blob => {
      const url = URL.createObjectURL(blob);
      a._blobUrl = url;
      a.loop = false; a.volume = 1;
      a.onplay = () => { dbg('‚ñ∂ EL OK', '#5a8a5a'); };
      a.onended = () => {
        if (a._blobUrl) { URL.revokeObjectURL(a._blobUrl); a._blobUrl = null; }
        const SILENT = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
        a.onplay = null; a.onended = null; a.onerror = null;
        a.src = SILENT; a.loop = true; a.volume = 0; a.play().catch(()=>{});
        if (onDone) onDone();
      };
      a.onerror = () => { dbg('EL onerror ‚Üí sistema', '#c03030'); _speakOneSystem(text, onDone); };
      a.src = url; a.load();
      a.play().catch(e => { dbg('play rifiutato: ' + e.name, '#c03030'); _speakOneSystem(text, onDone); });
    })
    .catch(err => {
      dbg('EL fetch err ‚Üí sistema: ' + err.message, '#c03030');
      _speakOneSystem(text, onDone);
    });
  } else {
    _speakOneSystem(text, onDone);
  }
}

function _speakOneSystem(text, onDone) {
  dbg('‚Üí voce sistema');
  const synth = window.speechSynthesis;
  if (!synth) { if (onDone) onDone(); return; }
  synth.cancel();

  function doSpeak(voices) {
    const u = new SpeechSynthesisUtterance(text.replace(/
/g, ' ').trim());
    const voice = getBestItalianVoice() || voices.find(v => v.lang.startsWith('it'));
    if (voice) { u.voice = voice; dbg('voce: ' + voice.name); }
    u.lang = 'it-IT'; u.rate = 0.9; u.pitch = 1.0; u.volume = 1;

    let kickTimer = null;
    u.onstart = () => {
      kickTimer = setInterval(() => {
        if (synth.speaking) { synth.pause(); synth.resume(); }
        else { clearInterval(kickTimer); kickTimer = null; }
      }, 10000);
    };
    const finish = () => {
      if (kickTimer) { clearInterval(kickTimer); kickTimer = null; }
      if (onDone) onDone();
    };
    u.onend = finish;
    u.onerror = (e) => {
      dbg('sistema errore: ' + (e.error||'?'), '#c03030');
      if (kickTimer) { clearInterval(kickTimer); kickTimer = null; }
      if (onDone) onDone();
    };
    synth.speak(u);
  }

  const voices = synth.getVoices();
  if (voices.length > 0) {
    doSpeak(voices);
  } else {
    let done = false;
    synth.onvoiceschanged = () => {
      if (done) return; done = true;
      synth.onvoiceschanged = preloadVoices;
      doSpeak(synth.getVoices());
    };
    setTimeout(() => {
      if (done) return; done = true;
      synth.onvoiceschanged = preloadVoices;
      doSpeak(synth.getVoices());
    }, 1200);
  }
}

function stopAudio() { audioStop(); }

function setAudioUI(on) {
  S.isSpeaking = on;
  const btn = document.getElementById('audio-btn');
  if (!btn) return;
  btn.classList.toggle('speaking', on);
  btn.classList.remove('loading');
  document.getElementById('audio-icon').textContent = on ? '‚ñ†' : '‚ñ∂';
  document.getElementById('audio-lbl').textContent = on ? 'In riproduzione ‚Äî tocca per fermare' : 'Ascolta narrazione';
}

// speakText compatibilit√†: resetta coda e parla subito
function speakText(text, label) {
  if (S.muted || !text) return;
  AUDIO_Q.items = []; AUDIO_Q.current = 0; AUDIO_Q.playing = false;
  _stopCurrentUtterance();
  queueSpeak(text, label || '‚ñ∂ Narrazione');
}

function toggleMute() {
  S.muted = !S.muted;
  const btn = document.getElementById('mute-btn');
  btn.textContent = S.muted ? 'üîá' : 'üîä';
  btn.classList.toggle('muted', S.muted);
  if (S.muted) { stopAudio(); setAudioUI(false); }
}

function speakCurrent() {
  dbg('speakCurrent() tap ‚Äî isSpeaking=' + S.isSpeaking + ' muted=' + S.muted + ' hasText=' + !!S.currentText);
  if (S.isSpeaking) { stopAudio(); setAudioUI(false); return; }
  if (!S.currentText || S.muted) return;
  speakText(S.currentText);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPROFONDISCI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function approfondisci() {
  if (!S.currentText || !S.openaiKey) return;
  const btn = document.getElementById('approfondisci-btn');
  btn.classList.add('loading');
  document.getElementById('approfondisci-lbl').textContent = 'Ricerca in corso...';
  document.getElementById('approfondisci-icon').textContent = '‚óå';

  const currentPlace = document.getElementById('frag-place').textContent.replace(/\s*cache\s*/,'').trim();
  const currentEpoch = document.getElementById('epoch-val').textContent;
  const pos = S.currentPos;

  const systemPrompt = `Sei uno storico che approfondisce la storia di un luogo specifico.
Rispondi SOLO con JSON valido in questo formato:
{
  "cronologia": "Sequenza di date e eventi chiave legati a questo luogo. Usa anni precisi quando disponibili. 80-120 parole.",
  "personaggi": "Persone reali legate a questo luogo: chi ci ha vissuto, lavorato, chi lo ha costruito, chi vi √® morto. Con date. 80-120 parole.",
  "connessioni": "Altri luoghi fisicamente vicini (<1km) che sono connessi storicamente a questo posto. Con distanza approssimativa e perch√© sono collegati. 80-120 parole.",
  "aneddoti": "Un aneddoto specifico, curioso o poco noto legato a questo luogo. Deve essere vero e verificabile. 80-120 parole."
}
Se un campo non ha dati sufficienti, usa null.
Non inventare mai fatti. Solo ci√≤ che √® documentato.`;

  const userPrompt = `Luogo: ${currentPlace}
Epoca principale: ${currentEpoch}
Coordinate: ${pos?.lat?.toFixed(5)}¬∞N, ${pos?.lon?.toFixed(5)}¬∞E
Narrazione gi√† mostrata all'utente:
${S.currentText}

Approfondisci con dati storici precisi.`;

  try {
    const data = await callOpenAI(systemPrompt, userPrompt);
    S.currentApprofondimento = data;

    document.getElementById('approfondimento-wrap').classList.add('on');

    const sections = [
      { key: 'cronologia', id: 'app-cronologia', textId: 'app-cronologia-text' },
      { key: 'personaggi', id: 'app-personaggi', textId: 'app-personaggi-text' },
      { key: 'connessioni', id: 'app-connessioni', textId: 'app-connessioni-text' },
      { key: 'aneddoti', id: 'app-aneddoti', textId: 'app-aneddoti-text' },
    ];

    // Mostra sezioni con typewrite e costruisce coda audio per sezione
    const sectionLabels = {
      cronologia: 'üìÖ Cronologia',
      personaggi: 'üë§ Personaggi',
      connessioni: 'üìç Luoghi vicini',
      aneddoti: '‚ú¶ Aneddoti'
    };

    // Reset coda audio (ferma narrazione corrente)
    AUDIO_Q.items = []; AUDIO_Q.current = 0; AUDIO_Q.playing = false;
    _stopCurrentUtterance();

    let firstDelay = 600; // ms prima di iniziare la lettura audio
    for (const s of sections) {
      if (data[s.key] && data[s.key] !== 'null') {
        const wrap = document.getElementById(s.id);
        const textEl = document.getElementById(s.textId);
        wrap.style.display = 'block';
        typewrite(data[s.key], textEl, 18);
        // Aggiungi alla coda audio come sezione separata
        if (!S.muted) {
          AUDIO_Q.items.push({ text: data[s.key], label: sectionLabels[s.key] || s.key });
        }
      }
    }

    btn.classList.add('done'); // nasconde il pulsante

    // Avvia coda audio dopo un breve delay (il typewrite sta gi√† partendo)
    if (!S.muted && AUDIO_Q.items.length > 0) {
      setTimeout(() => playNextInQueue(), firstDelay);
    }

  } catch(e) {
    btn.classList.remove('loading');
    document.getElementById('approfondisci-lbl').textContent = 'Approfondisci';
    document.getElementById('approfondisci-icon').textContent = '‚ú¶';
    console.error('Approfondisci error:', e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTracking() {
  if (!navigator.geolocation) {
    document.getElementById('gps-txt').textContent='GPS non disponibile'; return;
  }
  document.getElementById('gps-txt').textContent='ricerca GPS...';
  // iOS Safari: il dialog permesso √® gi√† stato triggerato dall'onclick del bottone.
  // Qui avviamo solo il watchPosition continuo.
  // Se _iosGps √® gi√† popolato (permesso gi√† dato), usiamo subito quella posizione.
  if (window._iosGps) {
    onPos(window._iosGps);
    window._iosGps = null;
  }
  S.watchId = navigator.geolocation.watchPosition(onPos, onErr,
    { enableHighAccuracy:true, maximumAge:3000, timeout:20000 });
}

function onPos(pos) {
  const { latitude:lat, longitude:lon, accuracy, speed } = pos.coords;
  document.getElementById('gps-dot').classList.add('lock');
  document.getElementById('gps-txt').textContent=`¬±${Math.round(accuracy)}m`;
  S.currentPos={lat,lon};
  // Traccia percorso per mappa
  S.pathCoords.push([lat,lon]);
  if (S.leafletMap && S.pathLine) {
    S.pathLine.setLatLngs(S.pathCoords);
    S.leafletMap.panTo([lat,lon]);
  }

  if (!S.gpsReady) {
    S.gpsReady=true; S.lastPos={lat,lon}; S.anchorPos={lat,lon};
    S.lastAddrPos={lat,lon};
    fetchAddress(lat, lon);
    triggerFrag(lat,lon,'primo_fix'); return;
  }

  const delta = haversine(S.lastPos.lat,S.lastPos.lon,lat,lon);
  // Solo movimenti reali: minimo 8m, max 600m (anti-teleport)
  // E controlliamo anche rispetto all'anchor per capire se ci si √® spostati davvero
  const anchorDelta = S.anchorPos ? haversine(S.anchorPos.lat,S.anchorPos.lon,lat,lon) : delta;
  
  if (delta > 8 && delta < 600 && anchorDelta > 5) {
    S.totalDist += delta;
    S.lastPos = {lat,lon};
    // Aggiorna anchor solo se ci si sposta stabilmente (>15m dall'anchor)
    if (anchorDelta > 15) S.anchorPos = {lat,lon};
    const spd = typeof speed==='number' && speed>=0 ? speed : delta/3;
    S.speedSamples.push(spd); if(S.speedSamples.length>8) S.speedSamples.shift();
    // Aggiorna indirizzo strip ogni ~30m di spostamento reale
    if (S.lastAddrPos) {
      const addrDelta = haversine(S.lastAddrPos.lat, S.lastAddrPos.lon, lat, lon);
      if (addrDelta > 30) { S.lastAddrPos={lat,lon}; fetchAddress(lat, lon); }
    }
  }

  updateUI();
  checkTrigger(lat,lon);
}

function onErr(e) {
  document.getElementById('gps-txt').textContent = e.code === 1 ? 'GPS negato' : e.code === 3 ? 'GPS timeout' : 'GPS errore';
  if (e.code === 1) {
    document.getElementById('search-txt').textContent = 'GPS bloccato ‚Äî vedi istruzioni sotto';
    // Banner persistente con istruzioni iOS
    if (!document.getElementById('gps-banner')) {
      const b = document.createElement('div');
      b.id = 'gps-banner';
      b.style.cssText = 'background:#1a0e0e;border-bottom:1px solid #5a2020;padding:0.9rem 1.5rem;font-size:0.78rem;color:#c07070;letter-spacing:0.06em;line-height:1.9;';
      b.innerHTML = '‚ö† GPS bloccato. Per abilitarlo:<br><strong style="color:#e08080;">Impostazioni ‚Üí Privacy e sicurezza ‚Üí Localizzazione ‚Üí Safari ‚Üí Consenti</strong><br><span style="color:var(--muted);font-size:0.72rem;">Poi ricarica la pagina.</span>';
      const header = document.querySelector('#app header');
      if (header) header.after(b);
    }
  }
}

function checkTrigger(lat,lon) {
  if (S.isGenerating) return;
  if (S.totalDist - S.lastFragAt >= INTERVAL) triggerFrag(lat,lon,'distanza');
}

function triggerFrag(lat,lon,reason) {
  if (S.isGenerating) return;
  const now = Date.now();
  if (reason !== 'primo_fix') {
    // Cooldown temporale: minimo 3 minuti tra frammenti
    if (now - S.lastFragTime < 180000) return;
    // Cooldown spaziale: deve essersi spostato almeno 30m dall'ultimo frammento
    if (S.lastFragPos) {
      const distFromLast = haversine(S.lastFragPos.lat, S.lastFragPos.lon, lat, lon);
      if (distFromLast < 30) return;
    }
  }
  S.lastFragAt = S.totalDist;
  S.lastFragTime = now;
  S.lastFragPos = {lat, lon};
  S.fragCount++;
  generateFrag(lat,lon,reason);
}

function updateUI() {
  const gap = S.totalDist - S.lastFragAt;
  const pct = Math.min(100,(gap/INTERVAL)*100);
  document.getElementById('s-dist').textContent=Math.round(S.totalDist);
  document.getElementById('s-frags').textContent=S.fragCount;
  document.getElementById('s-time').textContent=timeStr();
  document.getElementById('prog-fill').style.width=pct+'%';
  document.getElementById('prog-next').textContent=gap<INTERVAL?`~${Math.round(INTERVAL-gap)}m`:'ricerca...';
  if (S.epochsVisited.size>0) {
    const arr=[...S.epochsVisited];
    document.getElementById('s-layers').textContent=arr.length>1?`${arr.length}`:arr[0]||'‚Äî';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RICERCA DATI STORICI
// Wikipedia Geosearch + Overpass OSM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Rileva lingua Wikipedia in base alle coordinate (approssimazione per nazione)
async function detectWikiLang(lat, lon) {
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`);
    const d = await r.json();
    const cc = d.address?.country_code?.toLowerCase();
    const map = {
      'de':'de','at':'de','ch':'de',
      'fr':'fr','be':'fr',
      'es':'es','mx':'es','ar':'es','co':'es','pe':'es','cl':'es',
      'pt':'pt','br':'pt',
      'jp':'ja','cn':'zh','kr':'ko',
      'ru':'ru','ua':'ru',
      'pl':'pl','nl':'nl','se':'sv','no':'no','dk':'da',
      'gr':'el','tr':'tr','sa':'ar','eg':'ar','dz':'ar','ma':'ar',
      'in':'hi','id':'id','th':'th',
    };
    return map[cc] || 'en';
  } catch(e) { return 'en'; }
}

async function fetchWikiLang(lang, lat, lon, wikiData, sources) {
  try {
    const wr = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${lat}|${lon}&gsradius=600&gslimit=5&format=json&origin=*`);
    const wd = await wr.json();
    for (const p of (wd.query?.geosearch||[]).slice(0,3)) {
      try {
        const er = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&pageids=${p.pageid}&prop=extracts&exintro=true&exsentences=6&format=json&origin=*`);
        const ed = await er.json();
        const page = ed.query?.pages?.[p.pageid];
        if (page?.extract && !wikiData.find(w=>w.title===page.title)) {
          const extract = page.extract.replace(/<[^>]*>/g,'').slice(0,900);
          wikiData.push({ title:page.title, extract, dist:Math.round(p.dist), url:`https://${lang}.wikipedia.org/wiki/${encodeURIComponent(page.title)}`, lang });
          sources.push({ label:page.title + (lang!=='it'?` (${lang.toUpperCase()})` : ''), url:`https://${lang}.wikipedia.org/wiki/${encodeURIComponent(page.title)}` });
        }
      } catch(e) {}
    }
  } catch(e) {}
}

async function fetchHistoricalData(lat,lon) {
  setSearchStatus(true,'Rilevamento lingua locale...');
  const sources=[], wikiData=[], osmData=[];

  // 1. Rileva lingua locale
  const localLang = await detectWikiLang(lat, lon);

  // 2. Wikipedia IT (sempre, √® la lingua della narrazione)
  setSearchStatus(true,'Ricerca su Wikipedia IT...');
  await fetchWikiLang('it', lat, lon, wikiData, sources);

  // 3. Wikipedia lingua locale (se diversa da IT e EN)
  if (localLang !== 'it' && localLang !== 'en') {
    setSearchStatus(true,`Ricerca su Wikipedia ${localLang.toUpperCase()}...`);
    await fetchWikiLang(localLang, lat, lon, wikiData, sources);
  }

  // 4. Wikipedia EN (sempre come fonte aggiuntiva)
  if (wikiData.length < 3) {
    setSearchStatus(true,'Ricerca su Wikipedia EN...');
    await fetchWikiLang('en', lat, lon, wikiData, sources);
  }

  // 5. Overpass OSM
  setSearchStatus(true,'Ricerca su OpenStreetMap...');
  try {
    const q=`[out:json][timeout:8];(node["historic"](around:400,${lat},${lon});node["amenity"="place_of_worship"](around:400,${lat},${lon});way["historic"](around:400,${lat},${lon});relation["historic"](around:400,${lat},${lon}););out center tags 8;`;
    const ovr = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:'data='+encodeURIComponent(q)});
    const ovd = await ovr.json();
    for (const el of (ovd.elements||[]).slice(0,4)) {
      const t=el.tags||{};
      const name=t.name||t['name:it']||t['name:en'];
      if (name||t.historic) {
        osmData.push({ name:name||t.historic, type:t.historic||t.amenity||'luogo storico', description:t.description||t['description:it']||t.inscription, startDate:t.start_date, wikipedia:t.wikipedia });
        if (t.wikipedia) {
          const wp=t.wikipedia.split(':'); const wl=wp[0]||'it'; const wt=wp.slice(1).join(':');
          if (wt) sources.push({ label:name||wt, url:`https://${wl}.wikipedia.org/wiki/${encodeURIComponent(wt)}` });
        }
      }
    }
  } catch(e) {}

  // 6. Wikidata ‚Äî luoghi storici con coordinate e descrizione
  setSearchStatus(true,'Ricerca su Wikidata...');
  try {
    const sparql = `SELECT ?item ?itemLabel ?description ?inception ?coords WHERE {
      SERVICE wikibase:around { ?item wdt:P625 ?coords. bd:serviceParam wikibase:center "Point(${lon} ${lat})"^^geo:wktLiteral. bd:serviceParam wikibase:radius "0.4". }
      OPTIONAL { ?item schema:description ?description. FILTER(LANG(?description)="it" || LANG(?description)="en") }
      OPTIONAL { ?item wdt:P571 ?inception. }
      SERVICE wikibase:label { bd:serviceParam wikibase:language "it,en". }
    } LIMIT 5`;
    const wr = await fetch('https://query.wikidata.org/sparql?query='+encodeURIComponent(sparql), {
      headers:{'Accept':'application/sparql-results+json','User-Agent':'Strati/1.0'}
    });
    const wd = await wr.json();
    for (const row of (wd.results?.bindings||[]).slice(0,4)) {
      const name = row.itemLabel?.value;
      const desc = row.description?.value;
      const year = row.inception?.value ? new Date(row.inception.value).getFullYear() : null;
      const qid = row.item?.value?.split('/').pop();
      if (name && name !== qid && !wikiData.find(w=>w.title===name)) {
        wikiData.push({ title:name, extract:(desc||'')+(year?` (${year})`:''), dist:0, url:`https://www.wikidata.org/wiki/${qid}`, lang:'wd' });
        if (desc) sources.push({ label:name+' (Wikidata)', url:`https://www.wikidata.org/wiki/${qid}` });
      }
    }
  } catch(e) {}

  setSearchStatus(false,'');
  return { wikiData, osmData, sources };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INDIRIZZO INVERSO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchAddress(lat, lon) {
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=it&zoom=18&addressdetails=1`);
    const d = await r.json();
    const a = d.address || {};
    // Priorit√†: strada con numero civico
    const road = a.road || a.pedestrian || a.footway || a.cycleway || a.path || '';
    const num = a.house_number ? ' ' + a.house_number : '';
    const addr = road ? road + num : '';
    if (addr) {
      const strip = document.getElementById('addr-strip');
      if (strip) strip.textContent = addr;
    }
    return addr;
  } catch(e) { return ''; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FOTO DA WIKIPEDIA (immagine articolo pi√π vicino)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Foto rimosse: non √® possibile trovare immagini pertinenti in modo affidabile per strade/zone generiche

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GENERAZIONE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateFrag(lat,lon,reason) {
  S.isGenerating=true; S.currentSources=[]; S.currentApprofondimento=null;
  document.getElementById('gen-wrap').classList.add('on');
  document.getElementById('story-text').innerHTML='';
  document.getElementById('story-text').classList.remove('no-data');
  document.getElementById('sources-wrap').classList.remove('on');
  document.getElementById('place-photo-wrap').classList.remove('on');
  document.getElementById('place-photo-wrap').innerHTML='';
  document.getElementById('approfondisci-btn').style.display='none';
  document.getElementById('approfondisci-btn').className='approfondisci-btn';
  document.getElementById('approfondimento-wrap').classList.remove('on');
  ['app-cronologia','app-personaggi','app-connessioni','app-aneddoti'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  document.getElementById('frag-n').textContent=S.fragCount;
  document.getElementById('frag-place').textContent='Ricerca in corso...';
  document.getElementById('frag-address').textContent='';
  document.getElementById('frag-coords').textContent=`${lat.toFixed(4)}¬∞N ${lon.toFixed(4)}¬∞E`;

  // Fetch address in parallelo (leggero, sempre utile)
  fetchAddress(lat, lon).then(addr => {
    if (addr) document.getElementById('frag-address').textContent = addr;
  });
  // Foto: verr√† caricata DOPO la risposta di Groq, usando il nome del luogo narrato

  // ‚îÄ‚îÄ CACHE CHECK ‚îÄ‚îÄ
  const cacheKey = `strati_${lat.toFixed(3)}_${lon.toFixed(3)}`;
  const cached = loadCache(cacheKey);
  if (cached) {
    document.getElementById('gen-wrap').classList.remove('on');
    S.currentText = cached.text;
    S.currentSources = cached.sources||[];
    document.getElementById('frag-place').textContent = cached.place || 'Luogo';
    document.getElementById('epoch-val').textContent = cached.epoch || '‚Äî';
    const badge = '<span class="cache-badge">cache</span>';
    document.getElementById('frag-place').innerHTML = (cached.place||'Luogo') + badge;
    if (cached.epoch) S.epochsVisited.add(cached.epoch);
    if (cached.sources?.length>0) {
      document.getElementById('sources-list').innerHTML=cached.sources.map(s=>`<a class="source-tag" href="${s.url}" target="_blank" rel="noopener">${s.label}</a>`).join('');
      document.getElementById('sources-wrap').classList.add('on');
    }
    addHistory({lat,lon,place:cached.place,epoch:cached.epoch,text:cached.text});
    addMapMarker(lat,lon,cached.place,S.fragCount);
    doFlash(); vibrate([60,30,60]);
    if (!S.muted && cached.text) setTimeout(() => speakText(cached.text, '‚ñ∂ ' + (cached.place || 'Narrazione')), 400);
    typewrite(cached.text, document.getElementById('story-text'), 25, ()=>{
      document.getElementById('approfondisci-btn').style.display='flex';
    });
    S.isGenerating=false;
    return;
  }

  let histData={wikiData:[],osmData:[],sources:[]};
  try { histData=await fetchHistoricalData(lat,lon); } catch(e){}

  // ‚îÄ‚îÄ FILTRA: tieni solo dati entro 120m. Se nulla √® vicino, zona non documentata ‚îÄ‚îÄ
  const CLOSE_RADIUS = 120;
  histData.wikiData = histData.wikiData.filter(w => w.dist <= CLOSE_RADIUS);
  // rifiltra sources per tenere solo quelle dei wiki vicini
  const closeTitles = new Set(histData.wikiData.map(w=>w.title));
  histData.sources = histData.sources.filter(s => closeTitles.has(s.label.replace(/ \(IT\)|\(EN\)|\(Wikidata\)/g,'').trim()) || histData.osmData.length > 0);

  const noData = histData.wikiData.length===0 && histData.osmData.length===0;
  const h=new Date().getHours();
  const tod=h<6?'notte':h<12?'mattina':h<18?'pomeriggio':'sera';
  const currentAddr = document.getElementById('frag-address').textContent || document.getElementById('addr-strip').textContent || '';

  // ‚îÄ‚îÄ NESSUN DATO VICINO: mostra messaggio onesto, NIENTE Groq, NIENTE attrazioni lontane ‚îÄ‚îÄ
  if (noData) {
    const addr = currentAddr || 'questa zona';
    const noDataText = `Sei in ${addr}.\n\nIn quest'area non sono disponibili informazioni storiche documentate nelle fonti aperte.\n\nContinua a camminare.`;
    S.currentText = noDataText;
    document.getElementById('gen-wrap').classList.remove('on');
    document.getElementById('story-text').classList.add('no-data');
    document.getElementById('frag-place').textContent = addr;
    document.getElementById('epoch-val').textContent = '‚Äî';
    typewrite(noDataText, document.getElementById('story-text'), 22);
    addHistory({lat, lon, place: addr, epoch:'‚Äî', text: noDataText});
    addMapMarker(lat, lon, addr, S.fragCount);
    // Non parla per messaggi "nessun dato"
    S.isGenerating = false;
    return;
  }

  const systemPrompt = `Sei una guida narrativa storica che racconta la storia dei luoghi mentre qualcuno cammina.
Ricevi dati reali da Wikipedia e OpenStreetMap e li trasformi in narrazione coinvolgente.

FORMATO ‚Äî rispondi SOLO con JSON valido, nient'altro:
{
  "place": "Nome della via, piazza o zona dove si trova fisicamente l'utente (NON il nome di un monumento o attrazione)",
  "epoch": "Epoca principale (es: 'Medioevo', 'XIX secolo', 'anni Settanta', 'oggi')",
  "tone": "uno tra: drammatico | documentaristico | poetico | distaccato | solenne",
  "text": "Testo narrativo completo"
}

REGOLE TONO:
- Guerre, massacri, crimini gravi ‚Üí drammatico
- Fatti di cronaca, statistiche, dati ‚Üí distaccato
- Architettura, arte, luoghi sacri ‚Üí solenne o poetico
- Storia economica, politica, quotidiana ‚Üí documentaristico
- Paesaggi, natura, memoria collettiva ‚Üí poetico

REGOLE FONDAMENTALI:
- L'utente √® ESATTAMENTE alle coordinate date. I dati forniti sono di elementi che si trovano a quella stessa posizione (entro 120 metri).
- NON dire "stai camminando vicino a" o "nei pressi di" ‚Äî l'utente √® gi√† l√¨.
- Racconta la storia del luogo come se l'utente ci stesse camminando sopra.
- Seconda persona: "Stai camminando su...", "Sotto i tuoi piedi...", "Qui, dove ti trovi..."
- Fatti precisi, date, nomi reali ‚Äî MAI inventare
- 120-200 parole, vai a capo spesso`;

  let wikiStr='';
  if (histData.wikiData.length>0) {
    wikiStr='\nFONTI WIKIPEDIA (tutti entro 120m dalla posizione utente):\n'+histData.wikiData.map(w=>`‚Äî ${w.title} (a ${w.dist}m):\n${w.extract}`).join('\n\n');
  }
  let osmStr='';
  if (histData.osmData.length>0) {
    osmStr='\nFONTI OPENSTREETMAP:\n'+histData.osmData.map(o=>`‚Äî ${o.name} (${o.type})${o.startDate?' ¬∑ '+o.startDate:''}${o.description?' ¬∑ '+o.description:''}`).join('\n');
  }

  const userPrompt=`POSIZIONE UTENTE: ${lat.toFixed(5)}¬∞N, ${lon.toFixed(5)}¬∞E
Indirizzo: ${currentAddr || '(non disponibile)'}
Ora: ${timeStr()} (${tod}) ¬∑ Frammento n.${S.fragCount}

${wikiStr}
${osmStr}

Genera la narrazione per questa posizione esatta.`;

  try {
    const parsed = await callOpenAI(systemPrompt, userPrompt);

    S.currentText = parsed.text || '';
    S.currentSources = histData.sources;

    document.getElementById('frag-place').textContent = parsed.place || currentAddr || 'Luogo';
    document.getElementById('epoch-val').textContent = parsed.epoch || '‚Äî';
    if (parsed.epoch) S.epochsVisited.add(parsed.epoch);

    if (histData.sources.length>0) {
      document.getElementById('sources-list').innerHTML=histData.sources.map(s=>`<a class="source-tag" href="${s.url}" target="_blank" rel="noopener">${s.label}</a>`).join('');
      document.getElementById('sources-wrap').classList.add('on');
    }

    // Salva in cache
    saveCache(cacheKey, { place:parsed.place, epoch:parsed.epoch, text:parsed.text, sources:histData.sources });

    addHistory({lat,lon,place:parsed.place||currentAddr,epoch:parsed.epoch,text:parsed.text});
    addMapMarker(lat,lon,parsed.place||currentAddr,S.fragCount);
    doFlash(); vibrate([60,30,60]);

    document.getElementById('gen-wrap').classList.remove('on');

    // ‚îÄ‚îÄ AUDIO: parte subito (piccolo delay per iOS audio context) ‚îÄ‚îÄ
    if (!S.muted && parsed.text) {
      setTimeout(() => speakText(parsed.text, '‚ñ∂ ' + (parsed.place || 'Narrazione')), 400);
    }

    const speed=({drammatico:20,documentaristico:26,poetico:30,distaccato:22,solenne:28})[parsed.tone]||25;
    typewrite(parsed.text, document.getElementById('story-text'), speed, ()=>{
      document.getElementById('approfondisci-btn').style.display='flex';
    });

  } catch(e) {
    console.error('Groq error:',e);
    document.getElementById('gen-wrap').classList.remove('on');
    document.getElementById('story-text').textContent='Errore nella narrazione. Riprova tra qualche metro.';
    document.getElementById('frag-place').textContent='Errore';
  } finally { S.isGenerating=false; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSearchStatus(on,msg) {
  document.getElementById('search-dot').classList.toggle('on',on);
  document.getElementById('search-txt').textContent=msg;
}

function addHistory(item) { S.history.unshift(item); renderHistory(); }

function renderHistory() {
  document.getElementById('hist-list').innerHTML=S.history.slice(1,8).map((h,i)=>`
    <div class="hist-item" onclick="replayHist(${i+1})">
      <div class="hist-place">${h.place||'‚Äî'}</div>
      <div class="hist-epoch">${h.epoch||'‚Äî'}</div>
      <div class="hist-preview">${(h.text||'').slice(0,100).replace(/\n/g,' ')}${(h.text||'').length>100?'‚Ä¶':''}</div>
    </div>`).join('');
}

function replayHist(idx) {
  const h=S.history[idx]; if(!h) return;
  S.currentText=h.text;
  S.currentApprofondimento=null;
  document.getElementById('frag-place').textContent=h.place||'‚Äî';
  document.getElementById('epoch-val').textContent=h.epoch||'‚Äî';
  document.getElementById('frag-n').textContent=S.history.length-idx;
  document.getElementById('story-text').innerHTML='';
  // Reset approfondimento
  document.getElementById('approfondimento-wrap').classList.remove('on');
  document.getElementById('approfondisci-btn').className='approfondisci-btn';
  document.getElementById('approfondisci-btn').style.display='none';
  ['app-cronologia','app-personaggi','app-connessioni','app-aneddoti'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  typewrite(h.text,document.getElementById('story-text'),20,()=>{
    document.getElementById('approfondisci-btn').style.display='flex';
  });
}

let twT=null;
function typewrite(text,el,speed=25,onDone) {
  // Cancella solo il typewriter globale (narrazione principale)
  // Per approfondimento sections usiamo un timer locale
  const isMain = (el === document.getElementById('story-text'));
  if (isMain && twT) clearTimeout(twT);
  el.innerHTML=''; let i=0;
  let localTimer=null;
  const cur=document.createElement('span'); cur.className='cursor-blink'; el.appendChild(cur);
  function next() {
    if(i<text.length) {
      const c=text[i]; cur.before(c==='\n'?document.createElement('br'):document.createTextNode(c)); i++;
      const t = setTimeout(next,(c==='.'||c===','||c==='‚Ä¶')?speed*5:speed);
      if (isMain) twT=t; else localTimer=t;
    } else { cur.remove(); if(onDone) onDone(); }
  }
  next();
}

function haversine(la1,lo1,la2,lo2) {
  const R=6371000,dL=(la2-la1)*Math.PI/180,dO=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dO/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function timeStr() {
  const n=new Date();
  return `${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`;
}

function doFlash() { const el=document.getElementById('flash'); el.classList.add('on'); setTimeout(()=>el.classList.remove('on'),120); }
function vibrate(p) { if(navigator.vibrate) navigator.vibrate(p); }

function startApp() {
  if (!S.openaiKey) {
    alert('Inserisci e verifica la Groq API Key prima di iniziare.'); return;
  }
  dbg('startApp() ‚Äî avvio loop silenzioso');
  startSilentLoop();

  if (window.speechSynthesis) {
    // Pre-carica le voci (essenziale su iOS ‚Äî devono essere pronte prima della narrazione)
    preloadVoices();
    window.speechSynthesis.onvoiceschanged = preloadVoices;
    // Utterance silenziosa per sbloccare il contesto audio (iOS richiede gesto utente)
    const w = new SpeechSynthesisUtterance('  ');
    w.volume = 0; w.rate = 1; w.lang = 'it-IT';
    window.speechSynthesis.speak(w);
    w.onend = () => { dbg('warm-up completato, voci: ' + window.speechSynthesis.getVoices().length); };
    dbg('speechSynthesis warm-up inviato');
  }

  S.startTime = new Date();
  startTracking();
  document.getElementById('splash').classList.add('hidden');
  setTimeout(() => {
    document.getElementById('splash').style.display = 'none';
    document.getElementById('app').classList.add('visible');
    dbg('app visibile ‚Äî EL key: ' + (S.elKey ? 'S√å (' + S.elKey.slice(0,8) + '‚Ä¶)' : 'NO'));
    setTimeout(() => { if (!S.gpsReady) document.getElementById('gps-txt').textContent = 'GPS lento ‚Äî vai all\'aperto'; }, 8000);
  }, 1200);
}

setInterval(()=>document.getElementById('s-time').textContent=timeStr(),60000);
if(window.speechSynthesis) window.speechSynthesis.onvoiceschanged=()=>{};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BIOMETRIA ‚Äî salva/carica chiavi con Face ID / Touch ID
// Usa WebAuthn PRF extension per derivare una chiave AES-GCM
// Fallback: cifratura con password fissa (dispositivo-specifico)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BIO_KEY = 'strati_bio_v1';

async function bioInit() {
  const saved = localStorage.getItem(BIO_KEY);
  if (saved) {
    document.getElementById('start-btn-label').textContent = '‚ñ∂ Riprendi camminata';
    document.getElementById('manual-start-link').style.display = 'flex';
    document.getElementById('manual-start-link').style.gap = '0';
    // Pre-carica le chiavi silenziosamente
    try { await bioLoadSilent(); } catch(e) {}
  } else {
    document.getElementById('start-btn-label').textContent = 'Inizia a camminare';
  }
}

// Pulsante unificato
async function unifiedStart() {
  // Sblocca GPS immediatamente (sincrono)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(p => { window._iosGps = p; }, ()=>{}, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
  }

  const saved = localStorage.getItem(BIO_KEY);
  const st = document.getElementById('unified-st');

  if (saved) {
    // Ha chiavi salvate ‚Üí carica e parte
    st.textContent = 'Caricamento chiavi...';
    st.className = 'key-st';
    try {
      await bioLoadSilent();
      if (!S.openaiKey) { st.textContent = '‚úó Impossibile caricare le chiavi'; st.className='key-st err'; return; }
      st.textContent = '‚úì Chiavi caricate';
      st.className = 'key-st ok';
      setTimeout(() => startApp(), 400);
    } catch(e) {
      st.textContent = '‚úó ' + (e.message || 'Caricamento fallito');
      st.className = 'key-st err';
    }
  } else {
    // Nessuna chiave salvata ‚Üí parte direttamente (deve aver inserito key manualmente)
    if (!S.openaiKey) {
      st.textContent = '‚úó Inserisci e verifica la Groq API Key';
      st.className = 'key-st err';
      return;
    }
    // Salva chiavi in localStorage per la prossima volta
    try {
      await bioSaveSilent();
    } catch(e) { /* silenzioso se fallisce */ }
    setTimeout(() => startApp(), 200);
  }
}

function startAppDirect() {
  if (!S.openaiKey) {
    document.getElementById('unified-st').textContent = '‚úó Inserisci e verifica la Groq API Key';
    document.getElementById('unified-st').className = 'key-st err';
    return;
  }
  startApp();
}

function bioClearInline() {
  if (!confirm('Eliminare le chiavi salvate?')) return;
  localStorage.removeItem(BIO_KEY);
  document.getElementById('manual-start-link').style.display = 'none';
  document.getElementById('start-btn-label').textContent = 'Inizia a camminare';
  document.getElementById('unified-st').textContent = 'Chiavi eliminate';
  document.getElementById('unified-st').className = 'key-st';
  S.openaiKey = null; S.elKey = null;
  document.getElementById('gem-key').value = '';
  document.getElementById('el-key').value = '';
  document.getElementById('gem-st').textContent = '‚Üí Ottienila gratis su console.groq.com';
  document.getElementById('gem-st').className = 'key-st req';
  document.getElementById('el-st').textContent = 'Senza chiave: voce di sistema';
  document.getElementById('el-st').className = 'key-st';
}

// Chiave AES derivata da un segreto fisso + fingerprint del dispositivo
// Non √® crittografia a prova di NSA, ma protegge da lettura accidentale
async function deriveKey(salt) {
  const raw = new TextEncoder().encode('strati-' + navigator.userAgent.slice(0,50) + salt);
  const base = await crypto.subtle.importKey('raw', raw, 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name:'PBKDF2', salt: new TextEncoder().encode(salt), iterations:100000, hash:'SHA-256' },
    base, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']
  );
}

async function bioSave() {
  // Ora gestito da bioSaveSilent ‚Äî questa √® tenuta per retrocompatibilit√†
  await bioSaveSilent();
}

async function bioLoad() {
  const saved = localStorage.getItem(BIO_KEY);
  if (!saved) return;
  try {
    await bioLoadSilent();
  } catch(e) {}
}

// Versione silenziosa (usata da unifiedStart)
async function bioLoadSilent() {
  const saved = localStorage.getItem(BIO_KEY);
  if (!saved) return;

  // Nessun WebAuthn ‚Äî decifra direttamente con AES-GCM
  const data = JSON.parse(saved);
  const key = await deriveKey(data.salt);
  const iv = new Uint8Array(atob(data.iv).split('').map(c=>c.charCodeAt(0)));
  const ct = new Uint8Array(atob(data.ct).split('').map(c=>c.charCodeAt(0)));
  const dec = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);
  const payload = JSON.parse(new TextDecoder().decode(dec));

  if (payload.groq) {
    S.openaiKey = payload.groq;
    document.getElementById('gem-key').value = payload.groq;
  }
  if (payload.el) {
    S.elKey = payload.el;
    document.getElementById('el-key').value = payload.el;
    loadItalianVoice(payload.el);
  }
}

async function bioSaveSilent() {
  const groqKey = document.getElementById('gem-key').value.trim();
  const elKey = document.getElementById('el-key').value.trim();
  if (!groqKey) return;

  // Cifra con AES-GCM, nessun WebAuthn
  const salt = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));
  const key = await deriveKey(salt);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = await crypto.subtle.encrypt(
    { name:'AES-GCM', iv }, key,
    new TextEncoder().encode(JSON.stringify({ groq: groqKey, el: elKey }))
  );
  const data = {
    salt,
    iv: btoa(String.fromCharCode(...new Uint8Array(iv))),
    ct: btoa(String.fromCharCode(...new Uint8Array(enc)))
  };
  localStorage.setItem(BIO_KEY, JSON.stringify(data));
  document.getElementById('start-btn-label').textContent = '‚ñ∂ Riprendi camminata';
  document.getElementById('manual-start-link').style.display = 'flex';
}

function bioClear() {
  // Ora gestito da bioClearInline
  bioClearInline();
}

// Avvia controllo biometrico al caricamento
window.addEventListener('DOMContentLoaded', () => {
  bioInit();
  checkGpsPermission();
});

function checkGpsPermission() {
  if (!navigator.permissions) return;
  navigator.permissions.query({ name: 'geolocation' }).then(result => {
    if (result.state === 'denied') {
      document.getElementById('gps-denied-msg').style.display = 'block';
    }
    result.onchange = () => {
      if (result.state === 'denied') document.getElementById('gps-denied-msg').style.display = 'block';
      else document.getElementById('gps-denied-msg').style.display = 'none';
    };
  }).catch(() => {});
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveCache(key, data) {
  try {
    const all = JSON.parse(localStorage.getItem('strati_cache')||'{}');
    all[key] = { ...data, ts: Date.now() };
    // Mantieni max 100 voci
    const keys = Object.keys(all);
    if (keys.length > 100) {
      keys.sort((a,b)=>all[a].ts-all[b].ts).slice(0,keys.length-100).forEach(k=>delete all[k]);
    }
    localStorage.setItem('strati_cache', JSON.stringify(all));
  } catch(e) {}
}

function loadCache(key) {
  try {
    const all = JSON.parse(localStorage.getItem('strati_cache')||'{}');
    const v = all[key];
    if (!v) return null;
    // Cache valida per 30 giorni
    if (Date.now()-v.ts > 30*24*3600*1000) return null;
    return v;
  } catch(e) { return null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAPPA LEAFLET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMap() {
  S.mapVisible = !S.mapVisible;
  const btn = document.getElementById('map-toggle-btn');
  const container = document.getElementById('map-container');
  btn.classList.toggle('active', S.mapVisible);
  document.getElementById('map-icon').textContent = S.mapVisible ? '‚óâ' : '‚óé';
  document.getElementById('map-btn-txt').textContent = S.mapVisible ? ' Nascondi mappa' : ' Mostra percorso su mappa';
  container.classList.toggle('visible', S.mapVisible);

  if (S.mapVisible && !S.leafletMap) {
    initLeafletMap();
  } else if (S.mapVisible && S.leafletMap) {
    S.leafletMap.invalidateSize();
    if (S.pathCoords.length > 0) S.leafletMap.fitBounds(S.pathCoords);
  }
}

function initLeafletMap() {
  const center = S.currentPos ? [S.currentPos.lat, S.currentPos.lon] : [41.9, 12.5];
  S.leafletMap = L.map('map', { zoomControl:false, attributionControl:false }).setView(center, 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(S.leafletMap);

  S.markerLayer = L.layerGroup().addTo(S.leafletMap);
  S.pathLine = L.polyline(S.pathCoords, {
    color: '#c9a84c', weight: 2, opacity: 0.7, dashArray: '4 4'
  }).addTo(S.leafletMap);

  // Aggiunge marker gi√† esistenti
  S.history.forEach((h,i) => {
    if (h.lat && h.lon) addLeafletMarker(S.leafletMap, h.lat, h.lon, h.place, S.history.length-i, true);
  });
}

function addMapMarker(lat, lon, place, n) {
  if (S.leafletMap) {
    addLeafletMarker(S.leafletMap, lat, lon, place, n, false);
    S.pathLine.setLatLngs(S.pathCoords);
  }
}

function addLeafletMarker(map, lat, lon, place, n, silent) {
  const icon = L.divIcon({
    html: `<div style="width:20px;height:20px;border-radius:50%;background:#0c0b09;border:1.5px solid #c9a84c;display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-size:7px;color:#c9a84c;line-height:1;">${n}</div>`,
    className: '', iconSize: [20,20], iconAnchor: [10,10]
  });
  const marker = L.marker([lat,lon], {icon}).addTo(S.markerLayer||map);
  marker.bindPopup(`<span style="font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:#c9a84c;">${place||'‚Äî'}</span>`, {className:'strati-popup'});
  if (!silent) { map.panTo([lat,lon]); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FINE SESSIONE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function endSession() {
  if (S.history.length === 0) {
    alert('Nessuna narrazione registrata ancora. Cammina un po\'!');
    return;
  }
  const now = new Date();
  const dur = S.startTime ? Math.round((now - S.startTime)/60000) : '‚Äî';

  document.getElementById('end-date').textContent =
    now.toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) + ' ¬∑ ' + timeStr();
  document.getElementById('end-dist').textContent = Math.round(S.totalDist);
  document.getElementById('end-places').textContent = S.fragCount;
  document.getElementById('end-epochs-n').textContent = S.epochsVisited.size || '‚Äî';
  document.getElementById('end-duration').textContent = dur;

  // Epoche
  const epochsArr = [...S.epochsVisited];
  document.getElementById('end-epochs-list').innerHTML =
    epochsArr.map(e=>`<span class="epoch-pill">${e}</span>`).join('') || '<span style="color:var(--muted);font-size:0.75rem;">nessuna rilevata</span>';

  // Log narrativo
  document.getElementById('end-log-list').innerHTML = [...S.history].reverse().map((h,i)=>`
    <div class="end-log-item">
      <div class="end-log-place">${i+1}. ${h.place||'‚Äî'}</div>
      <div class="end-log-epoch">${h.epoch||'‚Äî'}</div>
      <div class="end-log-text">${(h.text||'').replace(/\n/g,'<br>')}</div>
    </div>`).join('');

  document.getElementById('end-overlay').classList.add('visible');

  // Mappa fine sessione
  setTimeout(()=>{
    if (!S.leafletEndMap && S.pathCoords.length > 0) {
      S.leafletEndMap = L.map('end-map', {zoomControl:false, attributionControl:false})
        .fitBounds(S.pathCoords.length>1 ? S.pathCoords : [[S.pathCoords[0][0]-0.005, S.pathCoords[0][1]-0.005],[S.pathCoords[0][0]+0.005, S.pathCoords[0][1]+0.005]]);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(S.leafletEndMap);
      L.polyline(S.pathCoords, {color:'#c9a84c',weight:2,opacity:0.7,dashArray:'4 4'}).addTo(S.leafletEndMap);
      [...S.history].reverse().forEach((h,i)=>{
        if (h.lat&&h.lon) addLeafletMarker(S.leafletEndMap,h.lat,h.lon,h.place,i+1,true);
      });
    } else if (S.leafletEndMap) {
      S.leafletEndMap.invalidateSize();
    }
  }, 300);
}

function closeEndSession() {
  document.getElementById('end-overlay').classList.remove('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESPORTA DIARIO HTML
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportDiary() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  const dur = S.startTime ? Math.round((now-S.startTime)/60000) : '‚Äî';
  const epochsArr = [...S.epochsVisited];

  const entriesHtml = [...S.history].reverse().map((h,i)=>`
    <div class="entry">
      <div class="entry-num">${i+1}</div>
      <div class="entry-body">
        <div class="entry-place">${h.place||'Luogo sconosciuto'}</div>
        <div class="entry-epoch">${h.epoch||'‚Äî'}</div>
        <div class="entry-coords">${h.lat?.toFixed(4)}¬∞N ${h.lon?.toFixed(4)}¬∞E</div>
        <div class="entry-text">${(h.text||'').replace(/\n/g,'<br>')}</div>
      </div>
    </div>`).join('');

  const html = `<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STRATI ‚Äî Diario del ${dateStr}</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0c0b09; --paper:#13120e; --gold:#c9a84c; --gold-dim:#6b5a2a; --text:#d4cfc0; --muted:#5a5548; }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'IBM Plex Mono',monospace; padding:2rem 1.5rem 4rem; max-width:680px; margin:0 auto; }
  .cover { text-align:center; padding:4rem 0 3rem; border-bottom:1px solid #1e1c18; margin-bottom:3rem; }
  .cover-eye { font-size:0.75rem; letter-spacing:0.5em; color:var(--muted); text-transform:uppercase; margin-bottom:1rem; }
  .cover-title { font-family:'Playfair Display',serif; font-size:clamp(3rem,15vw,7rem); color:var(--gold); font-weight:400; font-style:italic; letter-spacing:0.1em; line-height:1; }
  .cover-date { font-size:0.8rem; letter-spacing:0.2em; color:var(--muted); margin-top:1rem; }
  .stats { display:flex; justify-content:space-around; margin-bottom:3rem; padding:1.5rem; border:1px solid #1e1c18; }
  .stat { text-align:center; }
  .stat-val { font-family:'Playfair Display',serif; font-size:1.6rem; color:var(--gold); display:block; font-style:italic; }
  .stat-lbl { font-size:0.68rem; letter-spacing:0.25em; color:var(--muted); text-transform:uppercase; }
  .epochs { margin-bottom:3rem; }
  .section-lbl { font-size:0.72rem; letter-spacing:0.4em; color:var(--muted); text-transform:uppercase; margin-bottom:0.8rem; }
  .epoch-pill { display:inline-block; font-size:0.72rem; color:var(--gold-dim); border:1px solid #2a2418; padding:0.25rem 0.55rem; margin:0.2rem; }
  .entry { display:flex; gap:1.5rem; margin-bottom:2.5rem; padding-bottom:2.5rem; border-bottom:1px solid #131210; }
  .entry-num { font-family:'Playfair Display',serif; font-size:2.5rem; color:#1e1c18; font-style:italic; flex-shrink:0; line-height:1; width:2.5rem; text-align:right; }
  .entry-place { font-family:'Playfair Display',serif; font-size:1rem; color:var(--gold); font-style:italic; margin-bottom:0.3rem; }
  .entry-epoch { font-size:0.72rem; letter-spacing:0.2em; color:var(--muted); margin-bottom:0.2rem; }
  .entry-coords { font-size:0.68rem; letter-spacing:0.12em; color:#5a5548; margin-bottom:0.8rem; }
  .entry-text { font-size:0.85rem; line-height:2; color:var(--text); }
  .footer { text-align:center; padding-top:2rem; font-size:0.72rem; letter-spacing:0.3em; color:#5a5548; text-transform:uppercase; }
</style>
</head>
<body>
<div class="cover">
  <div class="cover-eye">Una camminata nella memoria</div>
  <div class="cover-title">Strati</div>
  <div class="cover-date">${dateStr}</div>
</div>
<div class="stats">
  <div class="stat"><span class="stat-val">${Math.round(S.totalDist)}</span><span class="stat-lbl">Metri</span></div>
  <div class="stat"><span class="stat-val">${S.fragCount}</span><span class="stat-lbl">Luoghi</span></div>
  <div class="stat"><span class="stat-val">${epochsArr.length||'‚Äî'}</span><span class="stat-lbl">Epoche</span></div>
  <div class="stat"><span class="stat-val">${dur}</span><span class="stat-lbl">Minuti</span></div>
</div>
${epochsArr.length>0?`<div class="epochs"><div class="section-lbl">Epoche attraversate</div>${epochsArr.map(e=>`<span class="epoch-pill">${e}</span>`).join('')}</div>`:''}
<div class="section-lbl" style="margin-bottom:1.5rem;">Diario</div>
${entriesHtml}
<div class="footer">Generato da STRATI ¬∑ ${dateStr}</div>
</body>
</html>`;

  const blob = new Blob([html], {type:'text/html;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `strati_${now.toISOString().slice(0,10)}.html`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
